<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Planos de A√ß√£o</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXUjNCVm5SAhdH8g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <!-- Sistema de Login -->
    <div id="login-section" class="login-container">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Login</h4>
            </div>
            <div class="card-body">
                <form id="login-form">
                    <div class="mb-3">
                        <label for="login-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="login-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="login-password" required>
                        <div class="form-text">
                            <a href="#" id="forgot-password-link">Esqueci minha senha</a>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Entrar</button>
                </form>
                <div class="mt-3 text-center">
                    <button id="register-btn" class="btn btn-link">Criar nova conta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de registro -->
    <div class="modal fade" id="register-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Criar Nova Conta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="register-form">
                        <div class="mb-3">
                            <label for="register-name" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="register-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="register-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-password" class="form-label">Senha</label>
                            <input type="password" class="form-control" id="register-password" minlength="8" required>
                            <div class="password-strength strength-0" id="password-strength"></div>
                            <div class="form-text">M√≠nimo 8 caracteres (letras, n√∫meros e s√≠mbolos)</div>
                        </div>
                        <div class="mb-3">
                            <label for="register-confirm-password" class="form-label">Confirmar Senha</label>
                            <input type="password" class="form-control" id="register-confirm-password" minlength="8" required>
                        </div>
                        <div class="mb-3" id="admin-code-container" style="display: none;">
                            <label for="admin-code" class="form-label">C√≥digo de Administrador</label>
                            <input type="password" class="form-control" id="admin-code" placeholder="Digite o c√≥digo secreto para admin">
                        </div>
                        <div class="mb-3">
                            <label for="register-user-type" class="form-label">Tipo de Usu√°rio</label>
                            <select class="form-select" id="register-user-type" required>
                                <option value="normal">Usu√°rio Normal</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Registrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de recupera√ß√£o de senha -->
    <div class="modal fade" id="reset-password-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Recupera√ß√£o de Senha</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reset-password-form">
                        <div class="mb-3">
                            <label for="reset-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="reset-email" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Enviar Link de Recupera√ß√£o</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sistema Principal (ap√≥s login) -->
    <div id="app-container" class="d-none">
        <div class="d-flex">
            <!-- Sidebar -->
            <div class="sidebar p-3" style="width: 250px;">
                <h4 class="text-center mb-4">Gestor de Planos</h4>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="dashboard">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="create-plan">
                            <i class="bi bi-file-earmark-plus"></i> Criar Plano
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="view-plans">
                            <i class="bi bi-list-check"></i> Planos Criados
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="view-actions">
                            <i class="bi bi-card-checklist"></i> A√ß√µes dos Planos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="manage-actions">
                            <i class="bi bi-gear"></i> Gerenciar A√ß√µes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="settings">
                            <i class="bi bi-envelope"></i> Notifica√ß√µes
                            <span id="notification-badge" class="badge bg-danger notification-badge d-none">0</span>
                        </a>
                    </li>
                    <li class="nav-item d-none" id="admin-menu-item">
                        <a class="nav-link" href="#" data-section="admin">
                            <i class="bi bi-shield-lock"></i> Administra√ß√£o
                            <span id="admin-badge" class="badge bg-danger notification-badge d-none">0</span>
                        </a>
                    </li>
                    <a class="nav-link" href="#" data-section="edit-plan">
                        <i class="bi bi-pencil-square"></i> Editar Planos
                    </a>
                    
                    <li class="nav-item mt-4">
                        <a class="nav-link text-danger" href="#" id="logout-btn">
                            <i class="bi bi-box-arrow-right"></i> Sair
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Conte√∫do Principal -->
            <div class="main-content flex-grow-1">
                <!-- Dashboard -->
                <div id="dashboard-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Dashboard</h2>
                        <div class="d-flex gap-2">
                            <div class="form-group">
                                <select id="dashboard-area-filter" class="form-select form-select-sm">
                                    <option value="">Todas as √Åreas</option>
                                    <option value="Seguran√ßa do Trabalho">Seguran√ßa do Trabalho</option>
                                    <option value="Ger√™ncia">Ger√™ncia</option>
                                    <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                                    <option value="Limpeza">Limpeza</option>
                                    <option value="Opera√ß√£o">Opera√ß√£o</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="dashboard-unit-filter" class="form-select form-select-sm">
                                    <option value="">Todas as Unidades</option>
                                    <option value="F√°brica Bel√©m">F√°brica Bel√©m</option>
                                    <option value="F√°brica Suzano">F√°brica Suzano</option>
                                    <option value="F√°brica Suzano Mogi Das Cruzes">F√°brica Suzano Mogi Das Cruzes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="dashboard-plan-filter" class="form-select form-select-sm">
                                    <option value="">Todos os Planos</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <h5 class="card-title">Progresso Total</h5>
                                    <div class="progress mt-3">
                                        <div id="total-progress" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                    <p class="mt-2 mb-0 text-muted">Conclus√£o geral de todos os planos</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <h5 class="card-title">Planos Ativos</h5>
                                    <h2 id="active-plans-count" class="display-6">0</h2>
                                    <p class="mb-0 text-muted">Planos em andamento</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <h5 class="card-title">A√ß√µes Pendentes</h5>
                                    <h2 id="pending-actions-count" class="display-6">0</h2>
                                    <p class="mb-0 text-muted">A√ß√µes n√£o conclu√≠das</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <h5 class="card-title">A√ß√µes Atrasadas</h5>
                                    <h2 id="late-actions-count" class="display-6">0</h2>
                                    <p class="mb-0 text-muted">A√ß√µes fora do prazo</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Planos por Status</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="plans-status-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">A√ß√µes por Prioridade</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="actions-priority-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">A√ß√µes por Respons√°vel</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="actions-responsible-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Status das A√ß√µes</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="actions-status-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Criar Plano de A√ß√£o -->
                <div id="create-plan-section" class="d-none">
                    <h2 class="mb-4">Criar Novo Plano de A√ß√£o</h2>
                    <div class="card">
                        <div class="card-body">
                            <form id="action-plan-form">
                                <div class="form-section">
                                    <h5 class="form-title">Informa√ß√µes B√°sicas do Plano</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="plan-title" class="form-label">T√≠tulo do Plano*</label>
                                            <input type="text" class="form-control" id="plan-title" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="plan-type" class="form-label">Tipo*</label>
                                            <select class="form-select" id="plan-type" required>
                                                <option value="">Selecione...</option>
                                                <option value="Estrat√©gico">Estrat√©gico</option>
                                                <option value="T√°tico">T√°tico</option>
                                                <option value="Operacional">Operacional</option>
                                                <option value="Melhoria">Melhoria</option>
                                                <option value="Corretivo">Corretivo</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="plan-area" class="form-label">√Årea*</label>
                                            <select class="form-select" id="plan-area" required>
                                                <option value="">Selecione...</option>
                                                <option value="Seguran√ßa do Trabalho">Seguran√ßa do Trabalho</option>
                                                <option value="Ger√™ncia">Ger√™ncia</option>
                                                <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                                                <option value="Limpeza">Limpeza</option>
                                                <option value="Opera√ß√£o">Opera√ß√£o</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="plan-unit" class="form-label">Unidade*</label>
                                            <select class="form-select" id="plan-unit" required>
                                                <option value="">Selecione...</option>
                                                <option value="F√°brica Bel√©m">F√°brica Bel√©m</option>
                                                <option value="F√°brica Suzano">F√°brica Suzano</option>
                                                <option value="F√°brica Suzano Mogi Das Cruzes">F√°brica Suzano Mogi Das Cruzes</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <label for="plan-description" class="form-label">Descri√ß√£o do Plano</label>
                                            <textarea class="form-control" id="plan-description" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section mt-4">
                                    <h5 class="form-title">Adicionar A√ß√µes ao Plano*</h5>
                                    <div id="action-items-container">
                                        <!-- A√ß√µes ser√£o adicionadas aqui dinamicamente -->
                                    </div>
                                    <button type="button" id="add-action-btn" class="btn btn-secondary mt-3">
                                        <i class="bi bi-plus-circle"></i> Adicionar A√ß√£o
                                    </button>
                                </div>

                                <div class="text-end mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> Salvar Plano de A√ß√£o
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Visualizar Planos Criados -->
                <div id="view-plans-section" class="d-none">
                    <h2 class="mb-4">Planos Criados</h2>
                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" id="search-plans-input" class="form-control" placeholder="Buscar planos...">
                                </div>
                                <div class="col-md-3">
                                    <select id="plans-area-filter" class="form-select">
                                        <option value="">Todas as √Åreas</option>
                                        <option value="Seguran√ßa do Trabalho">Seguran√ßa do Trabalho</option>
                                        <option value="Ger√™ncia">Ger√™ncia</option>
                                        <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                                        <option value="Limpeza">Limpeza</option>
                                        <option value="Opera√ß√£o">Opera√ß√£o</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select id="plans-unit-filter" class="form-select">
                                        <option value="">Todas as Unidades</option>
                                        <option value="F√°brica Bel√©m">F√°brica Bel√©m</option>
                                        <option value="F√°brica Suzano">F√°brica Suzano</option>
                                        <option value="F√°brica Suzano Mogi Das Cruzes">F√°brica Suzano Mogi Das Cruzes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>T√≠tulo</th>
                                            <th>√Årea</th>
                                            <th>Unidade</th>
                                            <th>Tipo</th>
                                            <th>Data Cria√ß√£o</th>
                                            <th>Progresso</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="plans-table-body">
                                        <!-- Planos ser√£o carregados aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visualizar A√ß√µes dos Planos -->
                <div id="view-actions-section" class="d-none">
                    <h2 class="mb-4">A√ß√µes dos Planos</h2>
                    <div class="card">
                        <div class="card-body">
                            <div class="mb-3 row">
                                <div class="col-md-4">
                                    <label for="plan-filter" class="form-label">Filtrar por Plano:</label>
                                    <select id="plan-filter" class="form-select">
                                        <option value="">Todos os Planos</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="action-status-filter" class="form-label">Filtrar por Status:</label>
                                    <select id="action-status-filter" class="form-select">
                                        <option value="">Todos</option>
                                        <option value="N√£o Iniciado">N√£o Iniciado</option>
                                        <option value="Em Andamento">Em Andamento</option>
                                        <option value="Conclu√≠do">Conclu√≠do</option>
                                        <option value="Cancelado">Cancelado</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="action-area-filter" class="form-label">Filtrar por √Årea:</label>
                                    <select id="action-area-filter" class="form-select">
                                        <option value="">Todas as √Åreas</option>
                                        <option value="Seguran√ßa do Trabalho">Seguran√ßa do Trabalho</option>
                                        <option value="Ger√™ncia">Ger√™ncia</option>
                                        <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                                        <option value="Limpeza">Limpeza</option>
                                        <option value="Opera√ß√£o">Opera√ß√£o</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <div class="col-md-6">
                                    <input type="text" id="search-actions-input" class="form-control" placeholder="Buscar a√ß√µes...">
                                </div>
                                <div class="col-md-6">
                                    <select id="action-unit-filter" class="form-select">
                                        <option value="">Todas as Unidades</option>
                                        <option value="F√°brica Bel√©m">F√°brica Bel√©m</option>
                                        <option value="F√°brica Suzano">F√°brica Suzano</option>
                                        <option value="F√°brica Suzano Mogi Das Cruzes">F√°brica Suzano Mogi Das Cruzes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Plano</th>
                                            <th>√Årea</th>
                                            <th>Unidade</th>
                                            <th>Objetivo</th>
                                            <th>Atividade</th>
                                            <th>Respons√°vel</th>
                                            <th>Status</th>
                                            <th>Prazo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="actions-table-body">
                                        <!-- A√ß√µes ser√£o carregadas aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gerenciar A√ß√µes -->
                <div id="manage-actions-section" class="d-none">
                    <h2 class="mb-4">Gerenciar A√ß√µes</h2>
                    <div class="card">
                        <div class="card-body">
                            <div class="mb-3 row">
                                <div class="col-md-4">
                                    <label for="manage-plan-filter" class="form-label">Filtrar por Plano:</label>
                                    <select id="manage-plan-filter" class="form-select">
                                        <option value="">Todos os Planos</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="status-filter" class="form-label">Filtrar por Status:</label>
                                    <select id="status-filter" class="form-select">
                                        <option value="">Todos</option>
                                        <option value="N√£o Iniciado">N√£o Iniciado</option>
                                        <option value="Em Andamento">Em Andamento</option>
                                        <option value="Conclu√≠do">Conclu√≠do</option>
                                        <option value="Cancelado">Cancelado</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="manage-area-filter" class="form-label">Filtrar por √Årea:</label>
                                    <select id="manage-area-filter" class="form-select">
                                        <option value="">Todas as √Åreas</option>
                                        <option value="Seguran√ßa do Trabalho">Seguran√ßa do Trabalho</option>
                                        <option value="Ger√™ncia">Ger√™ncia</option>
                                        <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                                        <option value="Limpeza">Limpeza</option>
                                        <option value="Opera√ß√£o">Opera√ß√£o</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <div class="col-md-6">
                                    <input type="text" id="search-manage-actions-input" class="form-control" placeholder="Buscar a√ß√µes...">
                                </div>
                                <div class="col-md-6">
                                    <select id="manage-unit-filter" class="form-select">
                                        <option value="">Todas as Unidades</option>
                                        <option value="F√°brica Bel√©m">F√°brica Bel√©m</option>
                                        <option value="F√°brica Suzano">F√°brica Suzano</option>
                                        <option value="F√°brica Suzano Mogi Das Cruzes">F√°brica Suzano Mogi Das Cruzes</option>
                                    </select>
                                </div>
                            </div>
                            <div id="manage-actions-container">
                                <!-- A√ß√µes para gerenciamento ser√£o carregadas aqui -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√µes de Notifica√ß√£o -->
                <div id="settings-section" class="d-none">
                    <h2 class="mb-4">Configura√ß√µes de Notifica√ß√£o</h2>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-4">Cadastro de Emails para Notifica√ß√£o</h5>
                            
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Os emails cadastrados abaixo receber√£o notifica√ß√µes di√°rias sobre a√ß√µes atrasadas.
                            </div>
                            
                            <form id="notification-form" class="mb-4">
                                <div class="row">
                                    <div class="col-md-8">
                                        <label for="notification-email" class="form-label">Email para Notifica√ß√£o</label>
                                        <input type="email" class="form-control" id="notification-email" placeholder="Digite o email que receber√° notifica√ß√µes" required>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-plus-circle"></i> Adicionar
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Email</th>
                                            <th>Data de Cadastro</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="notification-emails-table">
                                        <!-- Emails ser√£o carregados aqui -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-4">
                                <h5 class="card-title mb-3">Configura√ß√µes de Envio</h5>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable-notifications" checked>
                                    <label class="form-check-label" for="enable-notifications">Ativar notifica√ß√µes por email</label>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="notification-time" class="form-label">Hor√°rio de Envio</label>
                                        <select class="form-select" id="notification-time">
                                            <option value="08:00">08:00</option>
                                            <option value="09:00" selected>09:00</option>
                                            <option value="10:00">10:00</option>
                                            <option value="17:00">17:00</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button id="save-notification-settings" class="btn btn-success w-100">
                                            <i class="bi bi-save"></i> Salvar Configura√ß√µes
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button id="test-notification-btn" class="btn btn-outline-primary">
                                    <i class="bi bi-envelope"></i> Enviar Email de Teste
                                </button>
                                <small class="text-muted ms-2">Envia um email de teste para todos os cadastrados</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Menu de Administra√ß√£o -->
                <div id="admin-section" class="d-none">
                    <h2 class="mb-4">Administra√ß√£o</h2>
                    <div class="card">
                        <div class="card-body">
                            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="pending-requests-tab" data-bs-toggle="tab" data-bs-target="#pending-requests" type="button" role="tab">
                                        Solicita√ß√µes Pendentes <span id="pending-requests-badge" class="badge bg-danger ms-1">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                                        Usu√°rios
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                                        Logs do Sistema
                                    </button>
                                </li>
                            </ul>

                            
                            <div class="tab-content mt-3" id="adminTabsContent">
                                <div class="tab-pane fade show active" id="pending-requests" role="tabpanel">
                                    <div id="admin-requests-container">
                                        <!-- Solicita√ß√µes pendentes ser√£o carregadas aqui -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="users" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Nome</th>
                                                    <th>Email</th>
                                                    <th>Tipo de Usu√°rio</th>
                                                    <th>√öltimo Acesso</th>
                                                    <th>A√ß√µes</th>
                                                </tr>
                                            </thead>
                                            <tbody id="users-table-body">
                                                <!-- Usu√°rios ser√£o carregados aqui -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="logs" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Data/Hora</th>
                                                    <th>Usu√°rio</th>
                                                    <th>A√ß√£o</th>
                                                    <th>Detalhes</th>
                                                </tr>
                                            </thead>
                                            <tbody id="logs-table-body">
                                                <!-- Logs ser√£o carregados aqui -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <a href="fluter.html" class="floating-button">
                                üåê
                            </a>
                        </div>
                    </div>
                </div>

                
<div id="edit-plan-section" class="d-none">
    <h2 class="mb-4">Editar Planos e A√ß√µes</h2>
    <div class="card">
        <div class="card-body">
            <div class="mb-3 row">
                <div class="col-md-6">
                    <label for="edit-plan-filter" class="form-label">Selecionar Plano:</label>
                    <select id="edit-plan-filter" class="form-select">
                        <option value="">Selecione um plano...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="edit-plan-status-filter" class="form-label">Status:</label>
                    <select id="edit-plan-status-filter" class="form-select">
                        <option value="">Todos</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="edit-plan-area-filter" class="form-label">√Årea:</label>
                    <select id="edit-plan-area-filter" class="form-select">
                        <option value="">Todas</option>
                        <option value="Seguran√ßa do Trabalho">Seguran√ßa do Trabalho</option>
                        <option value="Ger√™ncia">Ger√™ncia</option>
                        <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                        <option value="Limpeza">Limpeza</option>
                        <option value="Opera√ß√£o">Opera√ß√£o</option>
                    </select>
                </div>
            </div>
            
            <div id="edit-plan-container" class="d-none">
                <form id="edit-plan-form">
                    <input type="hidden" id="edit-plan-id">
                    
                    <div class="form-section">
                        <h5 class="form-title">Informa√ß√µes B√°sicas do Plano</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="edit-plan-title" class="form-label">T√≠tulo do Plano*</label>
                                <input type="text" class="form-control" id="edit-plan-title" required>
                            </div>
                            <div class="col-md-6">
                                <label for="edit-plan-type" class="form-label">Tipo*</label>
                                <select class="form-select" id="edit-plan-type" required>
                                    <option value="">Selecione...</option>
                                    <option value="Estrat√©gico">Estrat√©gico</option>
                                    <option value="T√°tico">T√°tico</option>
                                    <option value="Operacional">Operacional</option>
                                    <option value="Melhoria">Melhoria</option>
                                    <option value="Corretivo">Corretivo</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="edit-plan-area" class="form-label">√Årea*</label>
                                <select class="form-select" id="edit-plan-area" required>
                                    <option value="">Selecione...</option>
                                    <option value="Seguran√ßa do Trabalho">Seguran√ßa do Trabalho</option>
                                    <option value="Ger√™ncia">Ger√™ncia</option>
                                    <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                                    <option value="Limpeza">Limpeza</option>
                                    <option value="Opera√ß√£o">Opera√ß√£o</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="edit-plan-unit" class="form-label">Unidade*</label>
                                <select class="form-select" id="edit-plan-unit" required>
                                    <option value="">Selecione...</option>
                                    <option value="F√°brica Bel√©m">F√°brica Bel√©m</option>
                                    <option value="F√°brica Suzano">F√°brica Suzano</option>
                                    <option value="F√°brica Suzano Mogi Das Cruzes">F√°brica Suzano Mogi Das Cruzes</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <label for="edit-plan-description" class="form-label">Descri√ß√£o do Plano</label>
                                <textarea class="form-control" id="edit-plan-description" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="edit-plan-status" class="form-label">Status do Plano</label>
                                <select class="form-select" id="edit-plan-status">
                                    <option value="Ativo">Ativo</option>
                                    <option value="Conclu√≠do">Conclu√≠do</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section mt-4">
                        <h5 class="form-title">A√ß√µes do Plano</h5>
                        <div id="edit-action-items-container">
                            <!-- A√ß√µes ser√£o adicionadas aqui dinamicamente -->
                        </div>
                         <button type="button" id="add-edit-action-btn" class="btn btn-secondary mt-3">
                            <i class="bi bi-plus-circle"></i> Adicionar Nova A√ß√£o
                        </button> 
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <!-- <button type="button" id="delete-plan-btn" class="btn btn-danger">
                            <i class="bi bi-trash"></i> Excluir Plano
                        </button> -->
                        <div>
                            <button type="button" id="cancel-edit-plan-btn" class="btn btn-secondary me-2">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Salvar Altera√ß√µes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <div id="no-plan-selected-message" class="text-center py-5">
                <i class="bi bi-file-earmark-text" style="font-size: 3rem; color: #6c757d;"></i>
                <h5 class="mt-3">Selecione um plano para editar</h5>
                <p class="text-muted">Escolha um plano na lista acima para visualizar e editar suas informa√ß√µes</p>
            </div>
        </div>
    </div>
</div>

<!-- Adicione este template para a√ß√µes edit√°veis -->
<template id="edit-action-item-template">
    <div class="action-item-form mb-4 p-3 border rounded">
        <input type="hidden" class="action-id">
        <div class="row">
            <div class="col-md-12">
                <label class="form-label">Objetivo Estrat√©gico*</label>
                <input type="text" class="form-control objective" required>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12">
                <label class="form-label">Atividade*</label>
                <input type="text" class="form-control activity" required>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12">
                <label class="form-label">Why - Porque?*</label>
                <textarea class="form-control why" rows="2" required></textarea>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12">
                <label class="form-label">How - Como?*</label>
                <textarea class="form-control how" rows="2" required></textarea>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-6">
                <label class="form-label">Respons√°vel*</label>
                <input type="text" class="form-control responsible" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Executor*</label>
                <input type="text" class="form-control executor" required>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-6">
                <label class="form-label">Data In√≠cio*</label>
                <input type="date" class="form-control start-date" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Data Fim*</label>
                <input type="date" class="form-control end-date" required>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12">
                <label class="form-label">Where - Onde?*</label>
                <input type="text" class="form-control where" required>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-6">
                <label class="form-label">Prioridade*</label>
                <select class="form-select priority">
                    <option value="Baixa">Baixa</option>
                    <option value="M√©dia">M√©dia</option>
                    <option value="Alta">Alta</option>
                    <option value="Cr√≠tica">Cr√≠tica</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Status*</label>
                <select class="form-select status">
                    <option value="N√£o Iniciado">N√£o Iniciado</option>
                    <option value="Em Andamento">Em Andamento</option>
                    <option value="Conclu√≠do">Conclu√≠do</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
            </div>
        </div>
        <div class="text-end mt-2">
            <button type="button" class="btn btn-sm btn-danger remove-action-btn">
                <i class="bi bi-trash"></i> Remover A√ß√£o
            </button>
        </div>
    </div>
</template>

<!-- Adicione este modal para confirmar exclus√£o -->
<div class="modal fade" id="confirm-delete-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este plano permanentemente? Esta a√ß√£o n√£o pode ser desfeita.</p>
                <p class="fw-bold">Todos os dados e a√ß√µes associadas ser√£o perdidos.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="confirm-delete-btn" class="btn btn-danger">Excluir Permanentemente</button>
            </div>
        </div>
    </div>
</div>

                <!-- Template para uma a√ß√£o (usado pelo JavaScript) -->
                <template id="action-item-template">
                    <div class="action-item-form mb-4 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-label">Objetivo Estrat√©gico</label>
                                <input type="text" class="form-control objective" required>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <label class="form-label">Atividade</label>
                                <input type="text" class="form-control activity" required>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <label class="form-label">Why - Porque?</label>
                                <textarea class="form-control why" rows="2" required></textarea>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <label class="form-label">How - Como?</label>
                                <textarea class="form-control how" rows="2" required></textarea>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">Respons√°vel</label>
                                <input type="text" class="form-control responsible" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Executor</label>
                                <input type="text" class="form-control executor" required>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">Data In√≠cio</label>
                                <input type="date" class="form-control start-date" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Data Fim</label>
                                <input type="date" class="form-control end-date" required>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <label class="form-label">Where - Onde?</label>
                                <input type="text" class="form-control where" required>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">Prioridade</label>
                                <select class="form-select priority">
                                    <option value="Baixa">Baixa</option>
                                    <option value="M√©dia" selected>M√©dia</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Cr√≠tica">Cr√≠tica</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <select class="form-select status">
                                    <option value="N√£o Iniciado">N√£o Iniciado</option>
                                    <option value="Em Andamento">Em Andamento</option>
                                    <option value="Conclu√≠do">Conclu√≠do</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-end mt-2">
                            <button type="button" class="btn btn-sm btn-danger remove-action-btn">
                                <i class="bi bi-trash"></i> Remover
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar/editar plano -->
    <div class="modal fade" id="plan-details-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="plan-details-title">Detalhes do Plano</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>Informa√ß√µes do Plano</h6>
                        <p><strong>T√≠tulo:</strong> <span id="modal-plan-title"></span></p>
                        <p><strong>Tipo:</strong> <span id="modal-plan-type"></span></p>
                        <p><strong>√Årea:</strong> <span id="modal-plan-area"></span></p>
                        <p><strong>Unidade:</strong> <span id="modal-plan-unit"></span></p>
                        <p><strong>Descri√ß√£o:</strong> <span id="modal-plan-description"></span></p>
                        <p><strong>Progresso:</strong> 
                            <div class="progress">
                                <div id="modal-plan-progress" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                            </div>
                        </p>
                        <div class="d-flex justify-content-end mt-2">
                            <button id="complete-plan-btn" class="btn btn-success me-2">Marcar como Conclu√≠do</button>
                            <button id="cancel-plan-btn" class="btn btn-danger">Cancelar Plano</button>
                        </div>
                    </div>
                    <hr>
                    <h6 class="mb-3">A√ß√µes do Plano</h6>
                    <div id="modal-actions-container">
                        <!-- A√ß√µes do plano ser√£o carregadas aqui -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para enviar evid√™ncia -->
    <div class="modal fade" id="evidence-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enviar Evid√™ncia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="evidence-form">
                        <input type="hidden" id="evidence-plan-id">
                        <input type="hidden" id="evidence-action-index">
                        <div class="mb-3">
                            <label for="evidence-comments" class="form-label">Coment√°rios</label>
                            <textarea class="form-control" id="evidence-comments" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="evidence-image" class="form-label">Imagem de Evid√™ncia</label>
                            <input type="file" class="form-control" id="evidence-image" accept="image/*">
                        </div>
                        <div id="evidence-preview" class="text-center mb-3 d-none">
                            <img id="evidence-preview-image" class="evidence-image" src="#" alt="Pr√©-visualiza√ß√£o da evid√™ncia">
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">Enviar Evid√™ncia</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script type="text/javascript">
        emailjs.init("lYRk8TyBCvr1Kx0Hx");
    </script>        
    <script>






// Adicione o item de menu na sidebar (acima do bot√£o Sair)
const editPlanMenuItem = document.createElement('li');
editPlanMenuItem.className = 'nav-item';

// Corrigindo a sele√ß√£o do item de logout - com verifica√ß√£o de exist√™ncia
const logoutLink = document.querySelector('.nav-item a[data-section="logout"]');
if (logoutLink) {
    const logoutItem = logoutLink.closest('.nav-item');
    if (logoutItem) {
        logoutItem.parentNode.insertBefore(editPlanMenuItem, logoutItem);
    } else {
        // Se n√£o encontrar o item de logout, adiciona no final da lista
        document.querySelector('.sidebar .nav').appendChild(editPlanMenuItem);
    }
} else {
    // Se n√£o encontrar o link de logout, adiciona no final da lista
    document.querySelector('.sidebar .nav').appendChild(editPlanMenuItem);
}
// Elementos da se√ß√£o de edi√ß√£o
const editPlanFilter = document.getElementById('edit-plan-filter');
const editPlanStatusFilter = document.getElementById('edit-plan-status-filter');
const editPlanAreaFilter = document.getElementById('edit-plan-area-filter');
const editPlanContainer = document.getElementById('edit-plan-container');
const noPlanSelectedMessage = document.getElementById('no-plan-selected-message');
const editPlanForm = document.getElementById('edit-plan-form');
const editPlanIdInput = document.getElementById('edit-plan-id');
const editPlanTitle = document.getElementById('edit-plan-title');
const editPlanType = document.getElementById('edit-plan-type');
const editPlanArea = document.getElementById('edit-plan-area');
const editPlanUnit = document.getElementById('edit-plan-unit');
const editPlanDescription = document.getElementById('edit-plan-description');
const editPlanStatus = document.getElementById('edit-plan-status');
const editActionItemsContainer = document.getElementById('edit-action-items-container');
const editActionItemTemplate = document.getElementById('edit-action-item-template');
const deletePlanBtn = document.getElementById('delete-plan-btn');
const cancelEditPlanBtn = document.getElementById('cancel-edit-plan-btn');
const confirmDeleteModal = document.getElementById('confirm-delete-modal') ? new bootstrap.Modal(document.getElementById('confirm-delete-modal')) : null;
const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

// Carregar filtros de planos
function loadEditPlanFilters() {
    if (!editPlanFilter) return;
    
    editPlanFilter.innerHTML = '<option value="">Selecione um plano...</option>';
    
    database.ref('plans').once('value')
        .then((snapshot) => {
            if (!snapshot.exists()) return;
            
            snapshot.forEach(planSnapshot => {
                const plan = planSnapshot.val();
                const option = document.createElement('option');
                option.value = planSnapshot.key;
                option.textContent = plan.title;
                editPlanFilter.appendChild(option);
            });
        });
}

// Selecionar plano para edi√ß√£o
if (editPlanFilter) {
    editPlanFilter.addEventListener('change', function() {
        const planId = this.value;
        
        if (!planId) {
            if (editPlanContainer) editPlanContainer.classList.add('d-none');
            if (noPlanSelectedMessage) noPlanSelectedMessage.classList.remove('d-none');
            return;
        }
        
        database.ref('plans/' + planId).once('value')
            .then((snapshot) => {
                const plan = snapshot.val();
                if (!plan) {
                    alert('Plano n√£o encontrado!');
                    if (editPlanFilter) editPlanFilter.value = '';
                    return;
                }
                
                // Preencher informa√ß√µes b√°sicas do plano
                if (editPlanIdInput) editPlanIdInput.value = planId;
                if (editPlanTitle) editPlanTitle.value = plan.title;
                if (editPlanType) editPlanType.value = plan.type;
                if (editPlanArea) editPlanArea.value = plan.area;
                if (editPlanUnit) editPlanUnit.value = plan.unit;
                if (editPlanDescription) editPlanDescription.value = plan.description || '';
                if (editPlanStatus) editPlanStatus.value = plan.status || 'Ativo';
                
                // Limpar a√ß√µes existentes
                if (editActionItemsContainer) editActionItemsContainer.innerHTML = '';
                
                // Adicionar a√ß√µes do plano
                if (plan.actions && plan.actions.length > 0 && editActionItemsContainer && editActionItemTemplate) {
                    plan.actions.forEach((action, index) => {
                        const actionItem = editActionItemTemplate.content.cloneNode(true);
                        const actionElement = actionItem.querySelector('.action-item-form');
                        
                        // Preencher todos os campos da a√ß√£o
                        actionElement.querySelector('.objective').value = action.objective || '';
                        actionElement.querySelector('.activity').value = action.activity || '';
                        actionElement.querySelector('.why').value = action.why || '';
                        actionElement.querySelector('.how').value = action.how || '';
                        actionElement.querySelector('.responsible').value = action.responsible || '';
                        actionElement.querySelector('.executor').value = action.executor || '';
                        actionElement.querySelector('.start-date').value = action.startDate || '';
                        actionElement.querySelector('.end-date').value = action.endDate || '';
                        actionElement.querySelector('.where').value = action.where || '';
                        actionElement.querySelector('.priority').value = action.priority || 'M√©dia';
                        actionElement.querySelector('.status').value = action.status || 'N√£o Iniciado';
                        
                        // Adicionar evento para remover a√ß√£o (desabilitado)
                        const removeBtn = actionElement.querySelector('.remove-action-btn');
                        if (removeBtn) {
                            removeBtn.disabled = true;
                            removeBtn.title = "N√£o √© poss√≠vel remover a√ß√µes existentes";
                        }
                        
                        editActionItemsContainer.appendChild(actionItem);
                    });
                    
                    if (editPlanContainer) editPlanContainer.classList.remove('d-none');
                    if (noPlanSelectedMessage) noPlanSelectedMessage.classList.add('d-none');
                } else {
                    alert('Este plano n√£o possui a√ß√µes para editar.');
                    if (editPlanFilter) editPlanFilter.value = '';
                    if (editPlanContainer) editPlanContainer.classList.add('d-none');
                    if (noPlanSelectedMessage) noPlanSelectedMessage.classList.remove('d-none');
                }
            })
            .catch(error => {
                alert('Erro ao carregar plano: ' + error.message);
                if (editPlanFilter) editPlanFilter.value = '';
            });
    });
}

// Salvar altera√ß√µes no plano
if (editPlanForm) {
    editPlanForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!currentUser) {
            alert('Voc√™ precisa estar logado para editar planos!');
            return;
        }
        
        const planId = editPlanIdInput ? editPlanIdInput.value : null;
        if (!planId) {
            alert('Nenhum plano selecionado para edi√ß√£o!');
            return;
        }
        
        const title = editPlanTitle ? editPlanTitle.value.trim() : '';
        const type = editPlanType ? editPlanType.value : '';
        const area = editPlanArea ? editPlanArea.value : '';
        const unit = editPlanUnit ? editPlanUnit.value : '';
        const description = editPlanDescription ? editPlanDescription.value.trim() : '';
        const status = editPlanStatus ? editPlanStatus.value : '';
        
        if (!title) {
            alert('O t√≠tulo do plano √© obrigat√≥rio!');
            return;
        }
        
        const actionItems = [];
        if (editActionItemsContainer) {
            document.querySelectorAll('#edit-action-items-container .action-item-form').forEach(item => {
                actionItems.push({
                    objective: item.querySelector('.objective').value.trim(),
                    activity: item.querySelector('.activity').value.trim(),
                    why: item.querySelector('.why').value.trim(),
                    how: item.querySelector('.how').value.trim(),
                    responsible: item.querySelector('.responsible').value.trim(),
                    executor: item.querySelector('.executor').value.trim(),
                    startDate: item.querySelector('.start-date').value,
                    endDate: item.querySelector('.end-date').value,
                    where: item.querySelector('.where').value.trim(),
                    priority: item.querySelector('.priority').value,
                    status: item.querySelector('.status').value,
                    completed: item.querySelector('.status').value === 'Conclu√≠do'
                });
            });
        }
        
        if (actionItems.length === 0) {
            alert('O plano deve ter pelo menos uma a√ß√£o!');
            return;
        }
        
        // Validar datas das a√ß√µes
        for (const action of actionItems) {
            if (new Date(action.endDate) < new Date(action.startDate)) {
                alert('A data de t√©rmino n√£o pode ser anterior √† data de in√≠cio em nenhuma a√ß√£o!');
                return;
            }
        }
        
        const submitBtn = editPlanForm.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';
        }
        
        const updates = {
            title: title,
            type: type,
            area: area,
            unit: unit,
            description: description,
            status: status,
            actions: actionItems,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            updatedBy: currentUser.uid,
            updatedByName: userData.name
        };
        
        database.ref('plans/' + planId).update(updates)
            .then(() => {
                // Registrar log
                return database.ref('system_logs').push().set({
                    type: 'plan_updated',
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: userData.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    details: `Plano "${title}" atualizado`,
                    planId: planId
                });
            })
            .then(() => {
                alert('Plano atualizado com sucesso!');
                if (typeof loadDashboardData === 'function') loadDashboardData();
                if (typeof loadPlansTable === 'function') loadPlansTable();
                if (typeof loadActionsTable === 'function') loadActionsTable();
                if (typeof loadManageActions === 'function') loadManageActions();
            })
            .catch(error => {
                alert('Erro ao atualizar plano: ' + error.message);
            })
            .finally(() => {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-save"></i> Salvar Altera√ß√µes';
                }
            });
    });
}

// Cancelar edi√ß√£o
if (cancelEditPlanBtn) {
    cancelEditPlanBtn.addEventListener('click', function() {
        const submitBtn = editPlanForm ? editPlanForm.querySelector('button[type="submit"]') : null;
        if (!submitBtn || !submitBtn.disabled || 
            confirm('Tem certeza que deseja cancelar as altera√ß√µes? Todas as mudan√ßas n√£o salvas ser√£o perdidas.')) {
            if (editPlanFilter) editPlanFilter.value = '';
            if (editPlanContainer) editPlanContainer.classList.add('d-none');
            if (noPlanSelectedMessage) noPlanSelectedMessage.classList.remove('d-none');
        }
    });
}

// Solicitar exclus√£o do plano
if (deletePlanBtn) {
    deletePlanBtn.addEventListener('click', function() {
        const planId = editPlanIdInput ? editPlanIdInput.value : null;
        if (!planId) {
            alert('Nenhum plano selecionado para exclus√£o!');
            return;
        }
        
        database.ref('plans/' + planId).once('value')
            .then((snapshot) => {
                const plan = snapshot.val();
                if (!plan) {
                    alert('Plano n√£o encontrado!');
                    return;
                }
                
                // Atualizar mensagem no modal de confirma√ß√£o
                const deletePlanTitle = document.getElementById('delete-plan-title');
                if (deletePlanTitle) deletePlanTitle.textContent = plan.title;
                if (confirmDeleteModal) confirmDeleteModal.show();
                
                // Configurar bot√£o de confirma√ß√£o
                if (confirmDeleteBtn) {
                    confirmDeleteBtn.onclick = function() {
                        confirmDeleteBtn.disabled = true;
                        confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Excluindo...';
                        
                        database.ref('plans/' + planId).remove()
                            .then(() => {
                                // Registrar log
                                return database.ref('system_logs').push().set({
                                    type: 'plan_deleted',
                                    userId: currentUser.uid,
                                    userEmail: currentUser.email,
                                    userName: userData.name,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                                    details: `Plano "${plan.title}" exclu√≠do`,
                                    planId: planId
                                });
                            })
                            .then(() => {
                                alert('Plano exclu√≠do com sucesso!');
                                if (confirmDeleteModal) confirmDeleteModal.hide();
                                if (editPlanFilter) editPlanFilter.value = '';
                                if (editPlanContainer) editPlanContainer.classList.add('d-none');
                                if (noPlanSelectedMessage) noPlanSelectedMessage.classList.remove('d-none');
                                
                                // Recarregar outras se√ß√µes
                                if (typeof loadDashboardData === 'function') loadDashboardData();
                                if (typeof loadPlansTable === 'function') loadPlansTable();
                                if (typeof loadActionsTable === 'function') loadActionsTable();
                                if (typeof loadManageActions === 'function') loadManageActions();
                                loadEditPlanFilters();
                            })
                            .catch(error => {
                                alert('Erro ao excluir plano: ' + error.message);
                            })
                            .finally(() => {
                                if (confirmDeleteBtn) {
                                    confirmDeleteBtn.disabled = false;
                                    confirmDeleteBtn.innerHTML = 'Confirmar Exclus√£o';
                                }
                            });
                    };
                }
            })
            .catch(error => {
                alert('Erro ao carregar plano: ' + error.message);
            });
    });
}

// Fechar modal ao clicar no bot√£o Cancelar
if (cancelDeleteBtn) {
    cancelDeleteBtn.addEventListener('click', function() {
        if (confirmDeleteModal) confirmDeleteModal.hide();
    });
}

// Filtros
if (editPlanStatusFilter) {
    editPlanStatusFilter.addEventListener('change', loadEditPlanFilters);
}
if (editPlanAreaFilter) {
    editPlanAreaFilter.addEventListener('change', loadEditPlanFilters);
}

// Carregar filtros quando a se√ß√£o for mostrada
const editPlanNavLink = document.querySelector('.nav-link[data-section="edit-plan"]');
if (editPlanNavLink) {
    editPlanNavLink.addEventListener('click', function() {
        loadEditPlanFilters();
    });
}





















        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAkFlGBKrXhgpAtxaJBuV2AweWoIA9VzmU",
            authDomain: "planaction-fb5c5.firebaseapp.com",
            databaseURL: "https://planaction-fb5c5-default-rtdb.firebaseio.com",
            projectId: "planaction-fb5c5",
            storageBucket: "planaction-fb5c5.appspot.com",
            messagingSenderId: "977704616512",
            appId: "1:977704616512:web:d0257d0ee1a76258fcd5a5",
            measurementId: "G-6WWK67L89X"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const ADMIN_SECRET_CODE = "admin@&locker#0945";

        // Vari√°veis globais
        let currentUser = null;
        let userData = null;
        let plansChart = null;
        let actionsChart = null;
        let responsibleChart = null;
        let actionsStatusChart = null;
        let notificationCheckInterval = null;
        let adminCheckInterval = null;
        const evidenceModal = new bootstrap.Modal(document.getElementById('evidence-modal'));
        const registerModal = new bootstrap.Modal(document.getElementById('register-modal'));
        const resetPasswordModal = new bootstrap.Modal(document.getElementById('reset-password-modal'));

        // Aguardar o DOM estar pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos da interface
            const loginSection = document.getElementById('login-section');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const registerBtn = document.getElementById('register-btn');
            const registerForm = document.getElementById('register-form');
            const registerUserType = document.getElementById('register-user-type');
            const adminCodeContainer = document.getElementById('admin-code-container');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const resetPasswordForm = document.getElementById('reset-password-form');
            const logoutBtn = document.getElementById('logout-btn');
            const addActionBtn = document.getElementById('add-action-btn');
            const actionItemsContainer = document.getElementById('action-items-container');
            const actionItemTemplate = document.getElementById('action-item-template');
            const actionPlanForm = document.getElementById('action-plan-form');
            const plansTableBody = document.getElementById('plans-table-body');
            const actionsTableBody = document.getElementById('actions-table-body');
            const manageActionsContainer = document.getElementById('manage-actions-container');
            const planFilter = document.getElementById('plan-filter');
            const managePlanFilter = document.getElementById('manage-plan-filter');
            const statusFilter = document.getElementById('status-filter');
            const actionStatusFilter = document.getElementById('action-status-filter');
            const dashboardPlanFilter = document.getElementById('dashboard-plan-filter');
            const dashboardAreaFilter = document.getElementById('dashboard-area-filter');
            const dashboardUnitFilter = document.getElementById('dashboard-unit-filter');
            const plansAreaFilter = document.getElementById('plans-area-filter');
            const plansUnitFilter = document.getElementById('plans-unit-filter');
            const actionAreaFilter = document.getElementById('action-area-filter');
            const actionUnitFilter = document.getElementById('action-unit-filter');
            const manageAreaFilter = document.getElementById('manage-area-filter');
            const manageUnitFilter = document.getElementById('manage-unit-filter');
            const searchPlansInput = document.getElementById('search-plans-input');
            const searchActionsInput = document.getElementById('search-actions-input');
            const searchManageActionsInput = document.getElementById('search-manage-actions-input');
            const planDetailsModal = new bootstrap.Modal(document.getElementById('plan-details-modal'));
            const completePlanBtn = document.getElementById('complete-plan-btn');
            const cancelPlanBtn = document.getElementById('cancel-plan-btn');
            const evidenceForm = document.getElementById('evidence-form');
            const evidenceImageInput = document.getElementById('evidence-image');
            const evidencePreview = document.getElementById('evidence-preview');
            const evidencePreviewImage = document.getElementById('evidence-preview-image');
            const adminMenuItem = document.getElementById('admin-menu-item');
            const adminRequestsContainer = document.getElementById('admin-requests-container');
            const pendingRequestsBadge = document.getElementById('pending-requests-badge');
            const usersTableBody = document.getElementById('users-table-body');
            const logsTableBody = document.getElementById('logs-table-body');
            const passwordStrength = document.getElementById('password-strength');
            const registerPassword = document.getElementById('register-password');
            
            // Elementos de notifica√ß√£o
            const notificationForm = document.getElementById('notification-form');
            const notificationEmailInput = document.getElementById('notification-email');
            const notificationEmailsTable = document.getElementById('notification-emails-table');
            const enableNotifications = document.getElementById('enable-notifications');
            const notificationTime = document.getElementById('notification-time');
            const saveNotificationSettings = document.getElementById('save-notification-settings');
            const testNotificationBtn = document.getElementById('test-notification-btn');
            const notificationBadge = document.getElementById('notification-badge');

            // Navega√ß√£o entre se√ß√µes
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    
                    // Atualizar badge de notifica√ß√£o
                    if (section === 'settings') {
                        updateNotificationBadge(0);
                    }
                    if (section === 'admin') {
                        updateAdminBadge(0);
                    }
                });
            });
            registerBtn.addEventListener('click', function(e) {
    e.preventDefault();
    registerModal.show();
});

            // Mostrar se√ß√£o espec√≠fica
            function showSection(section) {
                document.querySelectorAll('.main-content > div').forEach(div => {
                    div.classList.add('d-none');
                });
                document.querySelector(`.nav-link[data-section="${section}"]`).classList.add('active');
                document.querySelectorAll(`.nav-link:not([data-section="${section}"])`).forEach(link => {
                    link.classList.remove('active');
                });
                document.getElementById(`${section}-section`).classList.remove('d-none');
                
                // Carregar dados espec√≠ficos da se√ß√£o
                if (section === 'dashboard') {
                    loadDashboardData();
                } else if (section === 'view-plans') {
                    loadPlansTable();
                } else if (section === 'view-actions') {
                    loadActionsTable();
                } else if (section === 'manage-actions') {
                    loadManageActions();
                } else if (section === 'settings') {
                    loadNotificationSettings();
                    addPlanNotificationSection();
                } else if (section === 'admin') {
                    loadAdminRequests();
                    loadUsersTable();
                    loadSystemLogs();
                }
            }

            // Mostrar/ocultar campo de c√≥digo admin
            registerUserType.addEventListener('change', function() {
                adminCodeContainer.style.display = this.value === 'admin' ? 'block' : 'none';
            });

            // Verificar for√ßa da senha
            registerPassword.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                
                // Verificar comprimento
                if (password.length >= 8) strength++;
                // Verificar letras mai√∫sculas
                if (/[A-Z]/.test(password)) strength++;
                // Verificar n√∫meros
                if (/[0-9]/.test(password)) strength++;
                // Verificar caracteres especiais
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                
                // Atualizar visualiza√ß√£o
                passwordStrength.className = 'password-strength strength-' + strength;
            });

            // Registrar nova conta
            registerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                const userType = document.getElementById('register-user-type').value;
                const adminCode = document.getElementById('admin-code')?.value;

                // Valida√ß√µes
                if (password !== confirmPassword) {
                    alert('As senhas n√£o coincidem!');
                    return;
                }

                if (userType === 'admin' && adminCode !== ADMIN_SECRET_CODE) {
                    alert('C√≥digo de administrador inv√°lido!');
                    return;
                }

                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Criando conta...';

                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        return database.ref('users/' + user.uid).set({
                            name: name,
                            email: email,
                            userType: userType,
                            isAdmin: userType === 'admin',
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            lastLogin: null
                        });
                    })
                    .then(() => {
                        alert('Conta criada com sucesso!');
                        registerModal.hide();
                        registerForm.reset();
                        passwordStrength.className = 'password-strength strength-0';
                    })
                    .catch((error) => {
                        alert('Erro ao criar conta: ' + error.message);
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Registrar';
                    });
            });

            // Recupera√ß√£o de senha
            forgotPasswordLink.addEventListener('click', function(e) {
                e.preventDefault();
                resetPasswordModal.show();
            });

            resetPasswordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('reset-email').value;
                
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';

                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        alert('Email de recupera√ß√£o enviado com sucesso! Verifique sua caixa de entrada.');
                        resetPasswordModal.hide();
                        resetPasswordForm.reset();
                    })
                    .catch((error) => {
                        alert('Erro ao enviar email de recupera√ß√£o: ' + error.message);
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Enviar Link de Recupera√ß√£o';
                    });
            });

            // Login
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                const submitBtn = loginForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Entrando...';

                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        currentUser = userCredential.user;
                        return database.ref('users/' + currentUser.uid).once('value');
                    })
                    .then((snapshot) => {
                        if (!snapshot.exists()) {
                            throw new Error('Dados do usu√°rio n√£o encontrados');
                        }
                        
                        userData = snapshot.val();
                        
                        // Atualizar √∫ltimo login
                        return database.ref('users/' + currentUser.uid).update({
                            lastLogin: firebase.database.ServerValue.TIMESTAMP
                        });
                    })
                    .then(() => {
                        // Registrar log de login
                        return database.ref('system_logs').push().set({
                            type: 'login',
                            userId: currentUser.uid,
                            userEmail: currentUser.email,
                            userName: userData.name,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            details: 'Login realizado com sucesso'
                        });
                    })
                    .then(() => {
                        loginSection.classList.add('d-none');
                        appContainer.classList.remove('d-none');
                        showSection('dashboard');
                        
                        // Verificar se √© admin
                        if (userData.userType === 'admin' || userData.isAdmin) {
                            adminMenuItem.classList.remove('d-none');
                            startAdminCheck();
                        }
                        
                        // Carregar dados necess√°rios ap√≥s login
                        loadDashboardPlanFilter();
                        startNotificationCheck();
                    })
                    .catch((error) => {
                        console.error('Erro no login:', error);
                        alert('Erro ao fazer login: ' + error.message);
                        auth.signOut();
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Entrar';
                    });
            });

            // Logout
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Registrar log de logout
                database.ref('system_logs').push().set({
                    type: 'logout',
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: userData.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    details: 'Logout realizado'
                })
                .then(() => {
                    return auth.signOut();
                })
                .then(() => {
                    currentUser = null;
                    userData = null;
                    appContainer.classList.add('d-none');
                    loginSection.classList.remove('d-none');
                    loginForm.reset();
                    
                    // Parar verifica√ß√µes
                    stopNotificationCheck();
                    stopAdminCheck();
                })
                .catch((error) => {
                    alert('Erro ao fazer logout: ' + error.message);
                });
            });

            // Adicionar a√ß√£o ao formul√°rio
            addActionBtn.addEventListener('click', function() {
                const actionItem = actionItemTemplate.content.cloneNode(true);
                const removeBtn = actionItem.querySelector('.remove-action-btn');
                removeBtn.addEventListener('click', function() {
                    this.closest('.action-item-form').remove();
                });
                actionItemsContainer.appendChild(actionItem);
            });

            // Salvar plano de a√ß√£o
            actionPlanForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!currentUser) return;

                const title = document.getElementById('plan-title').value;
                const type = document.getElementById('plan-type').value;
                const area = document.getElementById('plan-area').value;
                const unit = document.getElementById('plan-unit').value;
                const description = document.getElementById('plan-description').value;
                const actionItems = [];

                document.querySelectorAll('.action-item-form').forEach(item => {
                    actionItems.push({
                        objective: item.querySelector('.objective').value,
                        activity: item.querySelector('.activity').value,
                        why: item.querySelector('.why').value,
                        how: item.querySelector('.how').value,
                        responsible: item.querySelector('.responsible').value,
                        executor: item.querySelector('.executor').value,
                        startDate: item.querySelector('.start-date').value,
                        endDate: item.querySelector('.end-date').value,
                        where: item.querySelector('.where').value,
                        priority: item.querySelector('.priority').value,
                        status: item.querySelector('.status').value,
                        completed: false,
                        evidence: null
                    });
                });

                if (actionItems.length === 0) {
                    alert('Adicione pelo menos uma a√ß√£o ao plano!');
                    return;
                }

                const submitBtn = actionPlanForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';

                const planRef = database.ref('plans').push();
                planRef.set({
                    title: title,
                    type: type,
                    area: area,
                    unit: unit,
                    description: description,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: currentUser.uid,
                    createdByName: userData.name,
                    actions: actionItems,
                    status: 'Ativo'
                })
                .then(() => {
                    // Registrar log
                    return database.ref('system_logs').push().set({
                        type: 'plan_created',
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        userName: userData.name,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        details: `Plano "${title}" criado com ${actionItems.length} a√ß√µes`,
                        planId: planRef.key
                    });
                })
                .then(() => {
                    alert('Plano de a√ß√£o salvo com sucesso!');
                    actionPlanForm.reset();
                    actionItemsContainer.innerHTML = '';
                    showSection('view-plans');
                })
                .catch((error) => {
                    alert('Erro ao salvar plano: ' + error.message);
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-save"></i> Salvar Plano de A√ß√£o';
                });
            });

            // Carregar dados do dashboard
            function loadDashboardData() {
                if (!currentUser) return;

                const planFilterValue = dashboardPlanFilter.value;
                const areaFilterValue = dashboardAreaFilter.value;
                const unitFilterValue = dashboardUnitFilter.value;

                let query = database.ref('plans');
                
                query.once('value')
                    .then((snapshot) => {
                        const plans = [];
                        let totalActions = 0;
                        let completedActions = 0;
                        let activePlans = 0;
                        let pendingActions = 0;
                        let lateActions = 0;
                        const today = new Date();

                        snapshot.forEach(planSnapshot => {
                            const plan = planSnapshot.val();
                            plan.id = planSnapshot.key;
                            
                            // Filtrar por plano selecionado
                            if (planFilterValue && planSnapshot.key !== planFilterValue) return;
                            
                            // Filtrar por √°rea selecionada
                            if (areaFilterValue && plan.area !== areaFilterValue) return;
                            
                            // Filtrar por unidade selecionada
                            if (unitFilterValue && plan.unit !== unitFilterValue) return;
                            
                            plans.push(plan);

                            if (plan.status === 'Ativo') activePlans++;

                            if (plan.actions) {
                                totalActions += plan.actions.length;
                                completedActions += plan.actions.filter(action => action.status === 'Conclu√≠do').length;
                                pendingActions += plan.actions.filter(action => action.status !== 'Conclu√≠do').length;
                                
                                // Verificar a√ß√µes atrasadas
                                plan.actions.forEach(action => {
                                    if (action.status !== 'Conclu√≠do' && action.endDate) {
                                        const endDate = new Date(action.endDate);
                                        if (endDate < today) {
                                            lateActions++;
                                        }
                                    }
                                });
                            }
                        });

                        // Atualizar contadores
                        document.getElementById('active-plans-count').textContent = activePlans;
                        document.getElementById('pending-actions-count').textContent = pendingActions;
                        document.getElementById('late-actions-count').textContent = lateActions;
                        
                        // Atualizar progresso total
                        const totalProgress = totalActions > 0 ? Math.round((completedActions / totalActions) * 100) : 0;
                        const totalProgressBar = document.getElementById('total-progress');
                        totalProgressBar.style.width = totalProgress + '%';
                        totalProgressBar.textContent = totalProgress + '%';

                        // Criar/atualizar gr√°ficos
                        updateCharts(plans);
                    });
            }

            // Atualizar gr√°ficos do dashboard
            function updateCharts(plans) {
                // Dados para gr√°fico de status dos planos
                const planStatusCounts = {
                    'Ativo': 0,
                    'Conclu√≠do': 0,
                    'Cancelado': 0
                };

                // Dados para gr√°fico de prioridade das a√ß√µes
                const actionPriorityCounts = {
                    'Baixa': 0,
                    'M√©dia': 0,
                    'Alta': 0,
                    'Cr√≠tica': 0
                };

                // Dados para gr√°fico de status das a√ß√µes
                const actionStatusCounts = {
                    'N√£o Iniciado': 0,
                    'Em Andamento': 0,
                    'Conclu√≠do': 0,
                    'Cancelado': 0
                };

                // Dados para gr√°fico de a√ß√µes por respons√°vel
                const responsibleCounts = {};

                plans.forEach(plan => {
                    planStatusCounts[plan.status] = (planStatusCounts[plan.status] || 0) + 1;

                    if (plan.actions) {
                        plan.actions.forEach(action => {
                            actionPriorityCounts[action.priority] = (actionPriorityCounts[action.priority] || 0) + 1;
                            actionStatusCounts[action.status] = (actionStatusCounts[action.status] || 0) + 1;
                            
                            // Contar a√ß√µes por respons√°vel
                            if (action.responsible) {
                                responsibleCounts[action.responsible] = (responsibleCounts[action.responsible] || 0) + 1;
                            }
                        });
                    }
                });

                // Ordenar respons√°veis por quantidade de a√ß√µes (top 5)
                const sortedResponsibles = Object.entries(responsibleCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const responsibleLabels = sortedResponsibles.map(item => item[0]);
                const responsibleData = sortedResponsibles.map(item => item[1]);

                // Obter contexto dos canvases
                const plansStatusCtx = document.getElementById('plans-status-chart').getContext('2d');
                const actionsPriorityCtx = document.getElementById('actions-priority-chart').getContext('2d');
                const actionsStatusCtx = document.getElementById('actions-status-chart').getContext('2d');
                const responsibleCtx = document.getElementById('actions-responsible-chart').getContext('2d');

                // Destruir gr√°ficos existentes
                if (plansChart) plansChart.destroy();
                if (actionsChart) actionsChart.destroy();
                if (actionsStatusChart) actionsStatusChart.destroy();
                if (responsibleChart) responsibleChart.destroy();

                // Criar gr√°fico de status dos planos
                plansChart = new Chart(plansStatusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(planStatusCounts),
                        datasets: [{
                            data: Object.values(planStatusCounts),
                            backgroundColor: [
                                '#007bff',
                                '#28a745',
                                '#dc3545'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.raw;
                                        const percentage = Math.round((value / total) * 100);
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Criar gr√°fico de prioridade das a√ß√µes
                actionsChart = new Chart(actionsPriorityCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(actionPriorityCounts),
                        datasets: [{
                            label: 'A√ß√µes por Prioridade',
                            data: Object.values(actionPriorityCounts),
                            backgroundColor: [
                                '#6c757d',
                                '#17a2b8',
                                '#ffc107',
                                '#dc3545'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.raw;
                                        const percentage = Math.round((value / total) * 100);
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Criar gr√°fico de status das a√ß√µes
                actionsStatusChart = new Chart(actionsStatusCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(actionStatusCounts),
                        datasets: [{
                            data: Object.values(actionStatusCounts),
                            backgroundColor: [
                                '#6c757d',
                                '#007bff',
                                '#28a745',
                                '#dc3545'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.raw;
                                        const percentage = Math.round((value / total) * 100);
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Criar gr√°fico de a√ß√µes por respons√°vel
                // No c√≥digo onde √© criado o gr√°fico "A√ß√µes por Respons√°vel", substitua a fun√ß√£o atual por esta vers√£o atualizada:

// Criar gr√°fico de a√ß√µes por respons√°vel
responsibleChart = new Chart(responsibleCtx, {
    type: 'bar',
    data: {
        labels: responsibleLabels,
        datasets: [
            {
                label: 'Total de A√ß√µes',
                data: responsibleData,
                backgroundColor: '#17a2b8'
            },
            {
                label: 'A√ß√µes Atrasadas',
                data: sortedResponsibles.map(item => {
                    const responsible = item[0];
                    let lateCount = 0;
                    const today = new Date();
                    
                    plans.forEach(plan => {
                        if (plan.actions) {
                            plan.actions.forEach(action => {
                                if (action.responsible === responsible && action.endDate) {
                                    const endDate = new Date(action.endDate);
                                    if (endDate < today && action.status !== 'Conclu√≠do') {
                                        lateCount++;
                                    }
                                }
                            });
                        }
                    });
                    
                    return lateCount;
                }),
                backgroundColor: '#dc3545'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                stacked: false
            },
            x: {
                stacked: false
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const total = plans.reduce((sum, plan) => sum + (plan.actions ? plan.actions.length : 0), 0);
                        const value = context.raw;
                        const percentage = Math.round((value / total) * 100);
                        const datasetLabel = context.dataset.label;
                        
                        if (datasetLabel === 'A√ß√µes Atrasadas') {
                            const responsible = context.label;
                            const totalActions = responsibleData[context.dataIndex];
                            const latePercentage = Math.round((value / totalActions) * 100);
                            return `${datasetLabel}: ${value} (${latePercentage}% das a√ß√µes deste respons√°vel)`;
                        }
                        
                        return `${datasetLabel}: ${value} (${percentage}% do total)`;
                    }
                }
            }
        }
    }
});
            }

            // Carregar planos para o filtro do dashboard
            function loadDashboardPlanFilter() {
                if (!currentUser) return;

                dashboardPlanFilter.innerHTML = '<option value="">Todos os Planos</option>';

                database.ref('plans').orderByChild('createdBy').equalTo(currentUser.uid).once('value')
                    .then((snapshot) => {
                        if (!snapshot.exists()) return;

                        snapshot.forEach(planSnapshot => {
                            const plan = planSnapshot.val();
                            const option = document.createElement('option');
                            option.value = planSnapshot.key;
                            option.textContent = plan.title;
                            dashboardPlanFilter.appendChild(option);
                        });
                    });
            }

            // Carregar tabela de planos
            function loadPlansTable() {
                if (!currentUser) return;

                plansTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Carregando...</td></tr>';

                const areaFilterValue = plansAreaFilter.value;
                const unitFilterValue = plansUnitFilter.value;
                const searchText = searchPlansInput.value.toLowerCase();

                let query = database.ref('plans');

                query.once('value')
                    .then((snapshot) => {
                        plansTableBody.innerHTML = '';

                        if (!snapshot.exists()) {
                            plansTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum plano encontrado</td></tr>';
                            return;
                        }

                        // Atualizar filtros de planos
                        planFilter.innerHTML = '<option value="">Todos os Planos</option>';
                        managePlanFilter.innerHTML = '<option value="">Todos os Planos</option>';
                        dashboardPlanFilter.innerHTML = '<option value="">Todos os Planos</option>';

                        snapshot.forEach(planSnapshot => {
                            const plan = planSnapshot.val();
                            plan.id = planSnapshot.key;

                            // Filtrar por √°rea selecionada
                            if (areaFilterValue && plan.area !== areaFilterValue) return;
                            
                            // Filtrar por unidade selecionada
                            if (unitFilterValue && plan.unit !== unitFilterValue) return;
                            
                            // Filtrar por texto de busca
                            if (searchText && !plan.title.toLowerCase().includes(searchText) && 
                                !plan.description.toLowerCase().includes(searchText)) {
                                return;
                            }

                            // Adicionar op√ß√£o aos filtros
                            const option = document.createElement('option');
                            option.value = plan.id;
                            option.textContent = plan.title;
                            planFilter.appendChild(option.cloneNode(true));
                            managePlanFilter.appendChild(option.cloneNode(true));
                            dashboardPlanFilter.appendChild(option.cloneNode(true));

                            // Calcular progresso
                            let progress = 0;
                            if (plan.actions && plan.actions.length > 0) {
                                const completed = plan.actions.filter(a => a.status === 'Conclu√≠do').length;
                                progress = Math.round((completed / plan.actions.length) * 100);
                            }

                            // Formatar data
                            const createdAt = new Date(plan.createdAt);
                            const dateStr = createdAt.toLocaleDateString('pt-BR');

                            // Adicionar linha √† tabela
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${plan.title}</td>
                                <td>${plan.area}</td>
                                <td>${plan.unit}</td>
                                <td>${plan.type}</td>
                                <td>${dateStr}</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: ${progress}%">${progress}%</div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge ${plan.status === 'Ativo' ? 'bg-primary' : plan.status === 'Conclu√≠do' ? 'bg-success' : 'bg-danger'}">
                                        ${plan.status}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary view-plan-btn" data-id="${plan.id}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            `;
                            plansTableBody.appendChild(row);
                        });

                        // Adicionar eventos aos bot√µes de visualiza√ß√£o
                        document.querySelectorAll('.view-plan-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const planId = this.getAttribute('data-id');
                                showPlanDetails(planId);
                            });
                        });
                    });
            }

            // Mostrar detalhes do plano em um modal
            function showPlanDetails(planId) {
                database.ref('plans/' + planId).once('value')
                    .then((snapshot) => {
                        const plan = snapshot.val();
                        if (!plan) return;

                        // Preencher informa√ß√µes b√°sicas do plano
                        document.getElementById('modal-plan-title').textContent = plan.title;
                        document.getElementById('modal-plan-type').textContent = plan.type;
                        document.getElementById('modal-plan-area').textContent = plan.area;
                        document.getElementById('modal-plan-unit').textContent = plan.unit;
                        document.getElementById('modal-plan-description').textContent = plan.description || 'Nenhuma descri√ß√£o fornecida';

                        // Calcular e mostrar progresso
                        let progress = 0;
                        if (plan.actions && plan.actions.length > 0) {
                            const completed = plan.actions.filter(a => a.status === 'Conclu√≠do').length;
                            progress = Math.round((completed / plan.actions.length) * 100);
                        }
                        const progressBar = document.getElementById('modal-plan-progress');
                        progressBar.style.width = progress + '%';
                        progressBar.textContent = progress + '%';

                        // Preencher a√ß√µes do plano
                        const actionsContainer = document.getElementById('modal-actions-container');
                        actionsContainer.innerHTML = '';

                        if (!plan.actions || plan.actions.length === 0) {
                            actionsContainer.innerHTML = '<p>Nenhuma a√ß√£o encontrada neste plano.</p>';
                            return;
                        }

                        plan.actions.forEach((action, index) => {
                            const actionElement = document.createElement('div');
                            actionElement.className = `action-item mb-3 p-3 rounded ${action.status === 'Conclu√≠do' ? 'completed' : 
                                                     action.status === 'Em Andamento' ? 'pending' : ''}`;
                            
                            // Verificar se a a√ß√£o est√° atrasada
                            const today = new Date();
                            const endDate = new Date(action.endDate);
                            const isLate = endDate < today && action.status !== 'Conclu√≠do';
                            
                            if (isLate) {
                                actionElement.classList.add('late');
                            }

                            actionElement.innerHTML = `
                                <h6>A√ß√£o ${index + 1}: ${action.activity}</h6>
                                <p><strong>Objetivo Estrat√©gico:</strong> ${action.objective}</p>
                                <p><strong>Porque (Why):</strong> ${action.why}</p>
                                <p><strong>Como (How):</strong> ${action.how}</p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <p><strong>Respons√°vel:</strong> ${action.responsible}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>Executor:</strong> ${action.executor}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>Onde (Where):</strong> ${action.where}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <p><strong>In√≠cio:</strong> ${formatDate(action.startDate)}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>T√©rmino:</strong> ${formatDate(action.endDate)} ${isLate ? '<span class="badge bg-danger">Atrasado</span>' : ''}</p>
                                    </div>
                                    <div class="col-md-2">
                                        <p><strong>Prioridade:</strong> <span class="badge ${getPriorityBadgeClass(action.priority)}">${action.priority}</span></p>
                                    </div>
                                    <div class="col-md-2">
                                        <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(action.status)}">${action.status}</span></p>
                                    </div>
                                </div>
                                ${action.status === 'Conclu√≠do' && action.evidence ? `
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <p><strong>Evid√™ncia:</strong></p>
                                        <p>${action.evidence.comments || 'Sem coment√°rios'}</p>
                                        <img src="${action.evidence.image}" class="evidence-image" alt="Evid√™ncia da a√ß√£o">
                                    </div>
                                </div>
                                ` : ''}
                                ${action.status !== 'Conclu√≠do' ? `
                                <div class="text-end mt-2">
                                    <button class="btn btn-sm btn-success send-evidence-btn" 
                                        data-plan-id="${planId}" 
                                        data-action-index="${index}">
                                        <i class="bi bi-check-circle"></i> Enviar Evid√™ncia
                                    </button>
                                </div>
                                ` : ''}
                                <hr>
                            `;
                            actionsContainer.appendChild(actionElement);
                        });

                        // Adicionar eventos aos bot√µes de evid√™ncia
                        document.querySelectorAll('.send-evidence-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const planId = this.getAttribute('data-plan-id');
                                const actionIndex = this.getAttribute('data-action-index');
                                
                                document.getElementById('evidence-plan-id').value = planId;
                                document.getElementById('evidence-action-index').value = actionIndex;
                                evidenceModal.show();
                            });
                        });

                        // Configurar bot√µes de concluir/cancelar plano
                        completePlanBtn.onclick = function() {
                            if (confirm('Tem certeza que deseja marcar este plano como conclu√≠do? Todas as a√ß√µes ser√£o marcadas como conclu√≠das.')) {
                                const updates = {};
                                
                                // Marcar todas as a√ß√µes como conclu√≠das
                                if (plan.actions && plan.actions.length > 0) {
                                    plan.actions.forEach((action, index) => {
                                        updates[`plans/${planId}/actions/${index}/status`] = 'Conclu√≠do';
                                        updates[`plans/${planId}/actions/${index}/completed`] = true;
                                    });
                                }
                                
                                // Marcar plano como conclu√≠do
                                updates[`plans/${planId}/status`] = 'Conclu√≠do';
                                
                                database.ref().update(updates)
                                    .then(() => {
                                        // Registrar log
                                        return database.ref('system_logs').push().set({
                                            type: 'plan_completed',
                                            userId: currentUser.uid,
                                            userEmail: currentUser.email,
                                            userName: userData.name,
                                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                                            details: `Plano "${plan.title}" marcado como conclu√≠do`,
                                            planId: planId
                                        });
                                    })
                                    .then(() => {
                                        alert('Plano marcado como conclu√≠do com sucesso!');
                                        planDetailsModal.hide();
                                        loadDashboardData();
                                        loadPlansTable();
                                        loadActionsTable();
                                        loadManageActions();
                                    })
                                    .catch(error => {
                                        alert('Erro ao marcar plano como conclu√≠do: ' + error.message);
                                    });
                            }
                        };

                        cancelPlanBtn.onclick = function() {
                            if (confirm('Tem certeza que deseja cancelar este plano? Todas as a√ß√µes ser√£o marcadas como canceladas.')) {
                                const updates = {};
                                
                                // Marcar todas as a√ß√µes como canceladas
                                if (plan.actions && plan.actions.length > 0) {
                                    plan.actions.forEach((action, index) => {
                                        updates[`plans/${planId}/actions/${index}/status`] = 'Cancelado';
                                        updates[`plans/${planId}/actions/${index}/completed`] = true;
                                    });
                                }
                                
                                // Marcar plano como cancelado
                                updates[`plans/${planId}/status`] = 'Cancelado';
                                
                                database.ref().update(updates)
                                    .then(() => {
                                        // Registrar log
                                        return database.ref('system_logs').push().set({
                                            type: 'plan_canceled',
                                            userId: currentUser.uid,
                                            userEmail: currentUser.email,
                                            userName: userData.name,
                                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                                            details: `Plano "${plan.title}" cancelado`,
                                            planId: planId
                                        });
                                    })
                                    .then(() => {
                                        alert('Plano cancelado com sucesso!');
                                        planDetailsModal.hide();
                                        loadDashboardData();
                                        loadPlansTable();
                                        loadActionsTable();
                                        loadManageActions();
                                    })
                                    .catch(error => {
                                        alert('Erro ao cancelar plano: ' + error.message);
                                    });
                            }
                        };

                        // Mostrar modal
                        document.getElementById('plan-details-title').textContent = `Detalhes: ${plan.title}`;
                        planDetailsModal.show();
                    });
            }

            // Enviar evid√™ncia de conclus√£o
            evidenceForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!currentUser) return;
                
                const planId = document.getElementById('evidence-plan-id').value;
                const actionIndex = document.getElementById('evidence-action-index').value;
                const comments = document.getElementById('evidence-comments').value;
                const imageFile = evidenceImageInput.files[0];
                
                if (!imageFile) {
                    alert('Por favor, selecione uma imagem como evid√™ncia');
                    return;
                }
                
                const submitBtn = evidenceForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';

                // Converter imagem para base64
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageBase64 = e.target.result;
                    
                    const evidence = {
                        comments: comments,
                        image: imageBase64,
                        sentBy: currentUser.uid,
                        sentByName: userData.name,
                        sentAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    // Atualizar a√ß√£o no Firebase
                    const updates = {};
                    updates[`plans/${planId}/actions/${actionIndex}/status`] = 'Conclu√≠do';
                    updates[`plans/${planId}/actions/${actionIndex}/evidence`] = evidence;
                    
                    database.ref().update(updates)
                        .then(() => {
                            // Registrar log
                            return database.ref('system_logs').push().set({
                                type: 'action_completed',
                                userId: currentUser.uid,
                                userEmail: currentUser.email,
                                userName: userData.name,
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                details: `A√ß√£o conclu√≠da no plano ${planId}`,
                                planId: planId,
                                actionIndex: actionIndex
                            });
                        })
                        .then(() => {
                            alert('Evid√™ncia enviada com sucesso!');
                            evidenceModal.hide();
                            evidenceForm.reset();
                            evidencePreview.classList.add('d-none');
                            
                            // Recarregar se√ß√µes relevantes
                            loadDashboardData();
                            loadPlansTable();
                            loadActionsTable();
                            loadManageActions();
                        })
                        .catch(error => {
                            alert('Erro ao enviar evid√™ncia: ' + error.message);
                        })
                        .finally(() => {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Enviar Evid√™ncia';
                        });
                };
                reader.readAsDataURL(imageFile);
            });
            
            // Pr√©-visualizar imagem de evid√™ncia
            evidenceImageInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        evidencePreviewImage.src = e.target.result;
                        evidencePreview.classList.remove('d-none');
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            // Carregar tabela de a√ß√µes
            function loadActionsTable() {
                if (!currentUser) return;

                actionsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Carregando...</td></tr>';

                const planFilterValue = planFilter.value;
                const statusFilterValue = actionStatusFilter.value;
                const areaFilterValue = actionAreaFilter.value;
                const unitFilterValue = actionUnitFilter.value;
                const searchText = searchActionsInput.value.toLowerCase();

                let query = database.ref('plans');

                query.once('value')
                    .then((snapshot) => {
                        actionsTableBody.innerHTML = '';

                        if (!snapshot.exists()) {
                            actionsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhuma a√ß√£o encontrada</td></tr>';
                            return;
                        }

                        let hasActions = false;

                        snapshot.forEach(planSnapshot => {
                            const plan = planSnapshot.val();
                            if (!plan.actions) return;

                            // Filtrar por plano selecionado
                            if (planFilterValue && planSnapshot.key !== planFilterValue) return;
                            
                            // Filtrar por √°rea selecionada
                            if (areaFilterValue && plan.area !== areaFilterValue) return;
                            
                            // Filtrar por unidade selecionada
                            if (unitFilterValue && plan.unit !== unitFilterValue) return;

                            plan.actions.forEach((action, index) => {
                                // Filtrar por status selecionado
                                if (statusFilterValue && action.status !== statusFilterValue) return;
                                
                                // Filtrar por texto de busca
                                if (searchText && !action.activity.toLowerCase().includes(searchText) && 
                                    !action.objective.toLowerCase().includes(searchText) &&
                                    !action.responsible.toLowerCase().includes(searchText)) {
                                    return;
                                }

                                hasActions = true;
                                const today = new Date();
                                const endDate = new Date(action.endDate);
                                const isLate = endDate < today && action.status !== 'Conclu√≠do';

                                const row = document.createElement('tr');
                                row.className = action.status === 'Conclu√≠do' ? 'table-success' : 
                                               isLate ? 'table-danger' : 
                                               action.status === 'Em Andamento' ? 'table-warning' : '';
                                row.innerHTML = `
                                    <td>${plan.title}</td>
                                    <td>${plan.area}</td>
                                    <td>${plan.unit}</td>
                                    <td>${action.objective}</td>
                                    <td>${action.activity}</td>
                                    <td>${action.responsible}</td>
                                    <td>
                                        <span class="badge ${getStatusBadgeClass(action.status)}">
                                            ${action.status} ${isLate ? '(Atrasado)' : ''}
                                        </span>
                                    </td>
                                    <td>${formatDate(action.endDate)}</td>
                                `;
                                actionsTableBody.appendChild(row);
                            });
                        });

                        if (!hasActions) {
                            actionsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhuma a√ß√£o encontrada com os filtros selecionados</td></tr>';
                        }
                    });
            }

            // Carregar a√ß√µes para gerenciamento
            function loadManageActions() {
                if (!currentUser) return;

                manageActionsContainer.innerHTML = '<div class="text-center my-4">Carregando...</div>';

                const planFilterValue = managePlanFilter.value;
                const statusFilterValue = statusFilter.value;
                const areaFilterValue = manageAreaFilter.value;
                const unitFilterValue = manageUnitFilter.value;
                const searchText = searchManageActionsInput.value.toLowerCase();

                let query = database.ref('plans');

                query.once('value')
                    .then((snapshot) => {
                        manageActionsContainer.innerHTML = '';

                        if (!snapshot.exists()) {
                            manageActionsContainer.innerHTML = '<div class="text-center my-4">Nenhuma a√ß√£o encontrada</div>';
                            return;
                        }

                        let hasActions = false;

                        snapshot.forEach(planSnapshot => {
                            const plan = planSnapshot.val();
                            if (!plan.actions) return;

                            // Filtrar por plano selecionado
                            if (planFilterValue && planSnapshot.key !== planFilterValue) return;
                            
                            // Filtrar por √°rea selecionada
                            if (areaFilterValue && plan.area !== areaFilterValue) return;
                            
                            // Filtrar por unidade selecionada
                            if (unitFilterValue && plan.unit !== unitFilterValue) return;

                            plan.actions.forEach((action, index) => {
                                // Filtrar por status selecionado
                                if (statusFilterValue && action.status !== statusFilterValue) return;
                                
                                // Filtrar por texto de busca
                                if (searchText && !action.activity.toLowerCase().includes(searchText) && 
                                    !action.objective.toLowerCase().includes(searchText) &&
                                    !action.responsible.toLowerCase().includes(searchText)) {
                                    return;
                                }

                                hasActions = true;
                                const today = new Date();
                                const endDate = new Date(action.endDate);
                                const isLate = endDate < today && action.status !== 'Conclu√≠do';

                                const actionId = `action-${planSnapshot.key}-${index}`;
                                if (document.getElementById(actionId)) return;

                                const actionElement = document.createElement('div');
                                actionElement.id = actionId;
                                actionElement.className = `action-item mb-3 p-3 rounded ${action.status === 'Conclu√≠do' ? 'completed' : 
                                                         action.status === 'Em Andamento' ? 'pending' : ''} ${isLate ? 'late' : ''}`;
                                
                                actionElement.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6>${action.activity}</h6>
                                            <p class="mb-1"><strong>Plano:</strong> ${plan.title}</p>
                                            <p class="mb-1"><strong>√Årea:</strong> ${plan.area}</p>
                                            <p class="mb-1"><strong>Unidade:</strong> ${plan.unit}</p>
                                            <p class="mb-1"><strong>How - Como? :</strong> ${action.how}</p>
                                            <p class="mb-1"><strong>Objetivo:</strong> ${action.objective}</p>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge ${getPriorityBadgeClass(action.priority)}">${action.priority}</span>
                                            <span class="badge ${getStatusBadgeClass(action.status)}">${action.status}</span>
                                            ${isLate ? '<span class="badge bg-danger">Atrasado</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-3">
                                            <p class="mb-1"><strong>Respons√°vel:</strong> ${action.responsible}</p>
                                        </div>
                                        <div class="col-md-3">
                                            <p class="mb-1"><strong>Executor:</strong> ${action.executor}</p>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-1">
                                                <strong>Prazo:</strong> 
                                                <span class="editable-date" 
                                                    data-plan-id="${planSnapshot.key}" 
                                                    data-action-index="${index}">
                                                    ${formatDate(action.endDate)}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex justify-content-end gap-2">
                                                ${action.status !== 'Conclu√≠do' ? `
                                                <button class="btn btn-sm btn-success complete-action-btn" 
                                                    data-plan-id="${planSnapshot.key}" 
                                                    data-action-index="${index}">
                                                    <i class="bi bi-check-circle"></i> Concluir
                                                </button>
                                                ` : ''}
                                                
                                                ${action.status !== 'Cancelado' ? `
                                                <button class="btn btn-sm btn-danger cancel-action-btn" 
                                                    data-plan-id="${planSnapshot.key}" 
                                                    data-action-index="${index}">
                                                    <i class="bi bi-x-circle"></i> Cancelar
                                                </button>
                                                ` : ''}
                                                
                                                ${action.status !== 'Conclu√≠do' ? `
                                                <button class="btn btn-sm btn-primary evidence-action-btn" 
                                                    data-plan-id="${planSnapshot.key}" 
                                                    data-action-index="${index}">
                                                    <i class="bi bi-image"></i> Evid√™ncia
                                                </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    ${action.status === 'Conclu√≠do' && action.evidence ? `
                                    <div class="row mt-2">
                                        <div class="col-md-12">
                                            <p><strong>Evid√™ncia:</strong></p>
                                            <p>${action.evidence.comments || 'Sem coment√°rios'}</p>
                                            <img src="${action.evidence.image}" class="evidence-image" alt="Evid√™ncia da a√ß√£o">
                                        </div>
                                    </div>
                                    ` : ''}
                                `;
                                manageActionsContainer.appendChild(actionElement);
                            });
                        });

                        if (!hasActions) {
                            manageActionsContainer.innerHTML = '<div class="text-center my-4">Nenhuma a√ß√£o encontrada com os filtros selecionados</div>';
                        }

                        // Adicionar eventos aos bot√µes de conclus√£o
                        document.querySelectorAll('.complete-action-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const planId = this.getAttribute('data-plan-id');
                                const actionIndex = this.getAttribute('data-action-index');
                                
                                if (confirm('Tem certeza que deseja marcar esta a√ß√£o como conclu√≠da?')) {
                                    const updates = {};
                                    updates[`plans/${planId}/actions/${actionIndex}/status`] = 'Conclu√≠do';
                                    updates[`plans/${planId}/actions/${actionIndex}/completed`] = true;
                                    
                                    database.ref().update(updates)
                                        .then(() => {
                                            // Registrar log
                                            return database.ref('system_logs').push().set({
                                                type: 'action_completed',
                                                userId: currentUser.uid,
                                                userEmail: currentUser.email,
                                                userName: userData.name,
                                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                                details: `A√ß√£o conclu√≠da no plano ${planId}`,
                                                planId: planId,
                                                actionIndex: actionIndex
                                            });
                                        })
                                        .then(() => {
                                            loadManageActions();
                                            loadDashboardData();
                                            loadPlansTable();
                                            loadActionsTable();
                                        })
                                        .catch(error => {
                                            alert('Erro ao marcar a√ß√£o como conclu√≠da: ' + error.message);
                                        });
                                }
                            });
                        });

                        // Adicionar eventos aos bot√µes de cancelamento
                        document.querySelectorAll('.cancel-action-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const planId = this.getAttribute('data-plan-id');
                                const actionIndex = this.getAttribute('data-action-index');
                                
                                if (confirm('Tem certeza que deseja cancelar esta a√ß√£o?')) {
                                    const updates = {};
                                    updates[`plans/${planId}/actions/${actionIndex}/status`] = 'Cancelado';
                                    updates[`plans/${planId}/actions/${actionIndex}/completed`] = true;
                                    
                                    database.ref().update(updates)
                                        .then(() => {
                                            // Registrar log
                                            return database.ref('system_logs').push().set({
                                                type: 'action_canceled',
                                                userId: currentUser.uid,
                                                userEmail: currentUser.email,
                                                userName: userData.name,
                                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                                details: `A√ß√£o cancelada no plano ${planId}`,
                                                planId: planId,
                                                actionIndex: actionIndex
                                            });
                                        })
                                        .then(() => {
                                            loadManageActions();
                                            loadDashboardData();
                                            loadPlansTable();
                                            loadActionsTable();
                                        })
                                        .catch(error => {
                                            alert('Erro ao cancelar a√ß√£o: ' + error.message);
                                        });
                                }
                            });
                        });

                        // Adicionar eventos aos bot√µes de evid√™ncia
                        document.querySelectorAll('.evidence-action-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const planId = this.getAttribute('data-plan-id');
                                const actionIndex = this.getAttribute('data-action-index');
                                
                                document.getElementById('evidence-plan-id').value = planId;
                                document.getElementById('evidence-action-index').value = actionIndex;
                                evidenceModal.show();
                            });
                        });

                        // Adicionar eventos para edi√ß√£o de datas
                        document.querySelectorAll('.editable-date').forEach(dateElement => {
                            dateElement.addEventListener('click', function() {
                                const planId = this.getAttribute('data-plan-id');
                                const actionIndex = parseInt(this.getAttribute('data-action-index'));
                                const originalText = this.textContent;
                                
                                // Obter a data atual do Firebase para este item
                                database.ref(`plans/${planId}/actions/${actionIndex}/endDate`).once('value')
                                    .then((snapshot) => {
                                        const currentDate = snapshot.val();
                                        const dateValue = currentDate ? new Date(currentDate).toISOString().split('T')[0] : '';
                                        
                                        // Criar input de data
                                        const dateInput = document.createElement('input');
                                        dateInput.type = 'date';
                                        dateInput.className = 'form-control form-control-sm';
                                        dateInput.value = dateValue;
                                        
                                        // Criar bot√µes
                                        const saveBtn = document.createElement('button');
                                        saveBtn.className = 'btn btn-sm btn-success save-date-btn';
                                        saveBtn.innerHTML = '<i class="bi bi-check"></i>';
                                        
                                        const cancelBtn = document.createElement('button');
                                        cancelBtn.className = 'btn btn-sm btn-danger cancel-date-btn';
                                        cancelBtn.innerHTML = '<i class="bi bi-x"></i>';
                                        
                                        // Criar container
                                        const container = document.createElement('div');
                                        container.className = 'date-input-container';
                                        container.appendChild(dateInput);
                                        container.appendChild(saveBtn);
                                        container.appendChild(cancelBtn);
                                        
                                        // Substituir o texto pelo input
                                        this.parentNode.replaceChild(container, this);
                                        
                                        // Evento para salvar
                                        saveBtn.addEventListener('click', function() {
                                            const newDate = dateInput.value;
                                            if (!newDate) {
                                                alert('Por favor, selecione uma data v√°lida');
                                                return;
                                            }
                                            
                                            // Verificar se o usu√°rio √© administrador
                                            if (userData.userType === 'admin' || userData.isAdmin) {
                                                // Atualizar diretamente no Firebase
                                                const updates = {};
                                                updates[`plans/${planId}/actions/${actionIndex}/endDate`] = newDate;
                                                
                                                database.ref().update(updates)
                                                    .then(() => {
                                                        // Registrar log
                                                        return database.ref('system_logs').push().set({
                                                            type: 'action_date_changed',
                                                            userId: currentUser.uid,
                                                            userEmail: currentUser.email,
                                                            userName: userData.name,
                                                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                                                            details: `Prazo da a√ß√£o alterado no plano ${planId}`,
                                                            planId: planId,
                                                            actionIndex: actionIndex,
                                                            oldDate: currentDate,
                                                            newDate: newDate
                                                        });
                                                    })
                                                    .then(() => {
                                                        // Recarregar a se√ß√£o de gerenciamento
                                                        loadManageActions();
                                                        // Recarregar outras se√ß√µes relevantes
                                                        loadDashboardData();
                                                        loadPlansTable();
                                                        loadActionsTable();
                                                    })
                                                    .catch(error => {
                                                        alert('Erro ao atualizar a data: ' + error.message);
                                                    });
                                            } else {
                                                // Usu√°rio normal - enviar solicita√ß√£o para administra√ß√£o
                                                const requestRef = database.ref('admin_requests').push();
                                                requestRef.set({
                                                    type: 'date_change',
                                                    planId: planId,
                                                    actionIndex: actionIndex,
                                                    currentDate: currentDate,
                                                    newDate: newDate,
                                                    requestedBy: currentUser.uid,
                                                    requestedByName: userData.name,
                                                    requestedAt: firebase.database.ServerValue.TIMESTAMP,
                                                    status: 'pending'
                                                })
                                                .then(() => {
                                                    // Registrar log
                                                    return database.ref('system_logs').push().set({
                                                        type: 'admin_request_created',
                                                        userId: currentUser.uid,
                                                        userEmail: currentUser.email,
                                                        userName: userData.name,
                                                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                                                        details: `Solicita√ß√£o de altera√ß√£o de prazo para a√ß√£o no plano ${planId}`,
                                                        planId: planId,
                                                        actionIndex: actionIndex,
                                                        requestId: requestRef.key
                                                    });
                                                })
                                                .then(() => {
                                                    alert('Solicita√ß√£o de altera√ß√£o de prazo enviada para administra√ß√£o.');
                                                    // Recarregar a se√ß√£o de gerenciamento
                                                    loadManageActions();
                                                })
                                                .catch(error => {
                                                    alert('Erro ao enviar solicita√ß√£o: ' + error.message);
                                                });
                                            }
                                        });
                                        
                                        // Evento para cancelar
                                        cancelBtn.addEventListener('click', function() {
                                            // Restaurar o texto original
                                            const span = document.createElement('span');
                                            span.className = 'editable-date';
                                            span.setAttribute('data-plan-id', planId);
                                            span.setAttribute('data-action-index', actionIndex);
                                            span.textContent = originalText;
                                            
                                            // Reaplicar o evento
                                            span.addEventListener('click', dateElement.click.bind(dateElement));
                                            
                                            container.parentNode.replaceChild(span, container);
                                        });
                                    });
                            });
                        });
                    });
            }
            

            // Adicionar nova a√ß√£o durante a edi√ß√£o
if (document.getElementById('add-edit-action-btn')) {
    document.getElementById('add-edit-action-btn').addEventListener('click', function() {
        if (!editActionItemTemplate || !editActionItemsContainer) {
            console.error('Elementos necess√°rios para adicionar a√ß√£o n√£o encontrados');
            return;
        }

        const actionItem = editActionItemTemplate.content.cloneNode(true);
        const actionElement = actionItem.querySelector('.action-item-form');
        
        // Habilitar bot√£o de remo√ß√£o para novas a√ß√µes (n√£o para as existentes)
        const removeBtn = actionElement.querySelector('.remove-action-btn');
        if (removeBtn) {
            removeBtn.disabled = false;
            removeBtn.title = "Remover esta a√ß√£o";
            removeBtn.addEventListener('click', function() {
                if (confirm('Tem certeza que deseja remover esta a√ß√£o?')) {
                    this.closest('.action-item-form').remove();
                }
            });
        }
        
        editActionItemsContainer.appendChild(actionItem);
    });
}
            // Carregar solicita√ß√µes de administra√ß√£o
            function loadAdminRequests() {
                if (!currentUser || !(userData.userType === 'admin' || userData.isAdmin)) return;
                
                adminRequestsContainer.innerHTML = '<div class="text-center my-4">Carregando...</div>';
                
                database.ref('admin_requests').orderByChild('status').equalTo('pending').once('value')
                    .then((snapshot) => {
                        adminRequestsContainer.innerHTML = '';
                        
                        if (!snapshot.exists()) {
                            adminRequestsContainer.innerHTML = '<div class="text-center my-4">Nenhuma solicita√ß√£o pendente</div>';
                            updateAdminBadge(0);
                            return;
                        }
                        
                        let requestCount = 0;
                        
                        snapshot.forEach(requestSnapshot => {
                            const request = requestSnapshot.val();
                            request.id = requestSnapshot.key;
                            
                            if (request.status === 'pending') {
                                requestCount++;
                                
                                const requestElement = document.createElement('div');
                                requestElement.className = 'admin-request-item';
                                
                                if (request.type === 'date_change') {
                                    requestElement.innerHTML = `
                                        <h6>Solicita√ß√£o de Altera√ß√£o de Prazo</h6>
                                        <p><strong>Solicitante:</strong> ${request.requestedByName}</p>
                                        <p><strong>Plano:</strong> ${request.planId}</p>
                                        <p><strong>A√ß√£o:</strong> ${request.actionIndex}</p>
                                        <p><strong>Data Atual:</strong> ${formatDate(request.currentDate)}</p>
                                        <p><strong>Nova Data:</strong> ${formatDate(request.newDate)}</p>
                                        <p><strong>Solicitado em:</strong> ${formatDate(request.requestedAt)}</p>
                                        <div class="d-flex justify-content-end gap-2 mt-2">
                                            <button class="btn btn-sm btn-success approve-request-btn" data-id="${request.id}">
                                                <i class="bi bi-check"></i> Aprovar
                                            </button>
                                            <button class="btn btn-sm btn-danger reject-request-btn" data-id="${request.id}">
                                                <i class="bi bi-x"></i> Rejeitar
                                            </button>
                                        </div>
                                    `;
                                }
                                
                                adminRequestsContainer.appendChild(requestElement);
                            }
                        });
                        
                        // Atualizar contador de solicita√ß√µes pendentes
                        updateAdminBadge(requestCount);
                        
                        // Adicionar eventos aos bot√µes de aprova√ß√£o/rejei√ß√£o
                        document.querySelectorAll('.approve-request-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const requestId = this.getAttribute('data-id');
                                processAdminRequest(requestId, true);
                            });
                        });
                        
                        document.querySelectorAll('.reject-request-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const requestId = this.getAttribute('data-id');
                                processAdminRequest(requestId, false);
                            });
                        });
                    });
            }
            

            // Adicionar se√ß√£o de notifica√ß√£o por plano
function addPlanNotificationSection() {
    const notificationSection = document.getElementById('notification-section');
    if (!notificationSection) return;

    // Criar container para sele√ß√£o de planos
    const planNotificationContainer = document.createElement('div');
    planNotificationContainer.className = 'card mb-4';
    planNotificationContainer.innerHTML = `
        <div class="card-header">
            <h5 class="mb-0">Notifica√ß√£o por Plano de A√ß√£o</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="notification-plan-select" class="form-label">Selecione um Plano de A√ß√£o:</label>
                <select id="notification-plan-select" class="form-select">
                    <option value="">Carregando planos...</option>
                </select>
            </div>
            <div id="plan-notification-details" class="d-none">
                <h6 class="mt-4">Detalhes do Plano</h6>
                <div id="plan-notification-info" class="mb-3"></div>
                
                <h6 class="mt-4">A√ß√µes Pendentes</h6>
                <div id="plan-notification-actions" class="mb-3"></div>
                
                <button id="send-plan-notification-btn" class="btn btn-primary">
                    <i class="bi bi-envelope"></i> Enviar Notifica√ß√£o
                </button>
            </div>
        </div>
    `;
    notificationSection.appendChild(planNotificationContainer);

    // Carregar planos n√£o conclu√≠dos no select
    loadNotificationPlans();

    // Configurar evento de sele√ß√£o de plano
    document.getElementById('notification-plan-select').addEventListener('change', function() {
        const planId = this.value;
        if (!planId) {
            document.getElementById('plan-notification-details').classList.add('d-none');
            return;
        }
        loadPlanNotificationDetails(planId);
    });

    // Configurar bot√£o de envio
    document.getElementById('send-plan-notification-btn').addEventListener('click', sendPlanNotification);
}

// Carregar planos n√£o conclu√≠dos para notifica√ß√£o
function loadNotificationPlans() {
    const planSelect = document.getElementById('notification-plan-select');
    if (!planSelect) return;

    database.ref('plans').once('value')
        .then((snapshot) => {
            planSelect.innerHTML = '<option value="">Selecione um plano...</option>';
            
            if (!snapshot.exists()) {
                planSelect.innerHTML = '<option value="">Nenhum plano encontrado</option>';
                return;
            }

            snapshot.forEach(planSnapshot => {
                const plan = planSnapshot.val();
                // Mostrar apenas planos n√£o conclu√≠dos
                if (plan.status !== 'Conclu√≠do') {
                    const option = document.createElement('option');
                    option.value = planSnapshot.key;
                    option.textContent = plan.title;
                    planSelect.appendChild(option);
                }
            });
        });
}

// Carregar detalhes do plano selecionado
function loadPlanNotificationDetails(planId) {
    const detailsContainer = document.getElementById('plan-notification-details');
    const infoContainer = document.getElementById('plan-notification-info');
    const actionsContainer = document.getElementById('plan-notification-actions');
    
    detailsContainer.classList.add('d-none');
    infoContainer.innerHTML = 'Carregando...';
    actionsContainer.innerHTML = '';

    database.ref('plans/' + planId).once('value')
        .then((snapshot) => {
            const plan = snapshot.val();
            if (!plan) {
                infoContainer.innerHTML = 'Plano n√£o encontrado';
                return;
            }

            // Mostrar informa√ß√µes b√°sicas do plano
            infoContainer.innerHTML = `
                <p><strong>T√≠tulo:</strong> ${plan.title}</p>
                <p><strong>√Årea:</strong> ${plan.area}</p>
                <p><strong>Unidade:</strong> ${plan.unit}</p>
                <p><strong>Status:</strong> ${plan.status}</p>
                <p><strong>Descri√ß√£o:</strong> ${plan.description || 'Nenhuma descri√ß√£o'}</p>
            `;

            // Mostrar a√ß√µes pendentes
            if (!plan.actions || plan.actions.length === 0) {
                actionsContainer.innerHTML = '<p>Nenhuma a√ß√£o encontrada neste plano.</p>';
            } else {
                const pendingActions = plan.actions.filter(action => 
                    action.status !== 'Conclu√≠do' && action.status !== 'Cancelado'
                );

                if (pendingActions.length === 0) {
                    actionsContainer.innerHTML = '<p>Todas as a√ß√µes deste plano est√£o conclu√≠das ou canceladas.</p>';
                } else {
                    let actionsHTML = '<ul class="list-group">';
                    pendingActions.forEach((action, index) => {
                        const endDate = action.endDate ? new Date(action.endDate) : null;
                        const isLate = endDate && endDate < new Date();
                        
                        actionsHTML += `
                            <li class="list-group-item">
                                <h6>A√ß√£o ${index + 1}: ${action.activity}</h6>
                                <p><strong>Respons√°vel:</strong> ${action.responsible}</p>
                                <p><strong>Prazo:</strong> ${formatDate(action.endDate)} 
                                    ${isLate ? '<span class="badge bg-danger">Atrasado</span>' : ''}
                                </p>
                                <p><strong>Status:</strong> ${action.status}</p>
                            </li>
                        `;
                    });
                    actionsHTML += '</ul>';
                    actionsContainer.innerHTML = actionsHTML;
                }
            }

            detailsContainer.classList.remove('d-none');
        });
}

// Enviar notifica√ß√£o para o plano selecionado
function sendPlanNotification() {
    const planId = document.getElementById('notification-plan-select').value;
    if (!planId || !currentUser) return;

    const btn = document.getElementById('send-plan-notification-btn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';

    // Primeiro, obter os emails cadastrados
    database.ref(`notification_emails/${currentUser.uid}`).once('value')
        .then((emailsSnapshot) => {
            if (!emailsSnapshot.exists()) {
                throw new Error('Nenhum email cadastrado para notifica√ß√£o');
            }

            // Obter detalhes do plano
            return Promise.all([
                emailsSnapshot,
                database.ref('plans/' + planId).once('value')
            ]);
        })
        .then(([emailsSnapshot, planSnapshot]) => {
            const plan = planSnapshot.val();
            if (!plan) {
                throw new Error('Plano n√£o encontrado');
            }

            // Filtrar apenas a√ß√µes pendentes
            const pendingActions = plan.actions ? 
                plan.actions.filter(action => 
                    action.status !== 'Conclu√≠do' && action.status !== 'Cancelado'
                ) : [];

            if (pendingActions.length === 0) {
                throw new Error('Nenhuma a√ß√£o pendente neste plano');
            }

            // Construir mensagem do email
            let message = `<h2>Notifica√ß√£o do Plano: ${plan.title}</h2>`;
            message += `<p>Ol√°, ${userData.name}!</p>`;
            message += `<p>Aqui est√° o status atual do plano <strong>${plan.title}</strong>:</p>`;
            
            message += `<h3 class="mt-4">A√ß√µes Pendentes</h3>`;
            message += `<ul>`;
            
            pendingActions.forEach((action, index) => {
                const endDate = action.endDate ? new Date(action.endDate) : null;
                const isLate = endDate && endDate < new Date();
                const daysLate = isLate ? Math.floor((new Date() - endDate) / (1000 * 60 * 60 * 24)) : 0;
                
                message += `<li>
                    <strong>${action.activity}</strong>
                    <p>Respons√°vel: ${action.responsible}</p>
                    <p>Prazo: ${formatDate(action.endDate)} ${isLate ? `(Atrasado ${daysLate} dias)` : ''}</p>
                    <p>Status: ${action.status}</p>
                </li>`;
            });
            
            message += `</ul>`;
            message += `<p class="mt-3">Acesse o sistema para atualizar o status deste plano.</p>`;

            // Enviar para cada email cadastrado
            const sendPromises = [];
            
            emailsSnapshot.forEach(emailSnap => {
                const data = emailSnap.val();
                const toEmail = typeof data === 'string' ? data : data.email;

                const params = {
                    to_email: toEmail,
                    name: userData.name,
                    message: message,
                    subject: `Atualiza√ß√£o do Plano: ${plan.title}`
                };

                sendPromises.push(
                    emailjs.send("service_98e468r", "template_mvgbfgp", params)
                        .then(() => {
                            // Registrar log para cada email enviado
                            return database.ref('system_logs').push().set({
                                type: 'plan_notification_sent',
                                userId: currentUser.uid,
                                userEmail: currentUser.email,
                                userName: userData.name,
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                details: `Notifica√ß√£o do plano ${plan.title} enviada para ${toEmail}`,
                                planId: planId,
                                recipient: toEmail,
                                actionsCount: pendingActions.length
                            });
                        })
                );
            });

            return Promise.all(sendPromises);
        })
        .then(() => {
            alert('Notifica√ß√£o enviada com sucesso para todos os emails cadastrados!');
        })
        .catch(error => {
            alert('Erro ao enviar notifica√ß√£o: ' + error.message);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
}


            // Processar solicita√ß√£o de administra√ß√£o
            function processAdminRequest(requestId, approve) {
                database.ref(`admin_requests/${requestId}`).once('value')
                    .then((snapshot) => {
                        const request = snapshot.val();
                        
                        if (!request || request.status !== 'pending') {
                            alert('Solicita√ß√£o n√£o encontrada ou j√° processada');
                            return;
                        }
                        
                        // Atualizar status da solicita√ß√£o
                        const updates = {};
                        updates[`admin_requests/${requestId}/status`] = approve ? 'approved' : 'rejected';
                        updates[`admin_requests/${requestId}/processedBy`] = currentUser.uid;
                        updates[`admin_requests/${requestId}/processedByName`] = userData.name;
                        updates[`admin_requests/${requestId}/processedAt`] = firebase.database.ServerValue.TIMESTAMP;
                        
                        // Se for aprova√ß√£o, aplicar a altera√ß√£o
                        if (approve && request.type === 'date_change') {
                            updates[`plans/${request.planId}/actions/${request.actionIndex}/endDate`] = request.newDate;
                        }
                        
                        return database.ref().update(updates);
                    })
                    .then(() => {
                        // Registrar log
                        return database.ref('system_logs').push().set({
                            type: 'admin_request_processed',
                            userId: currentUser.uid,
                            userEmail: currentUser.email,
                            userName: userData.name,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            details: `Solicita√ß√£o ${approve ? 'aprovada' : 'rejeitada'}: ${requestId}`,
                            requestId: requestId,
                            action: approve ? 'approved' : 'rejected'
                        });
                    })
                    .then(() => {
                        alert(`Solicita√ß√£o ${approve ? 'aprovada' : 'rejeitada'} com sucesso!`);
                        loadAdminRequests();
                    })
                    .catch(error => {
                        alert('Erro ao processar solicita√ß√£o: ' + error.message);
                    });
            }
            
            // Carregar tabela de usu√°rios
            function loadUsersTable() {
                if (!currentUser || !(userData.userType === 'admin' || userData.isAdmin)) return;
                
                usersTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando...</td></tr>';
                
                database.ref('users').once('value')
                    .then((snapshot) => {
                        usersTableBody.innerHTML = '';
                        
                        if (!snapshot.exists()) {
                            usersTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum usu√°rio encontrado</td></tr>';
                            return;
                        }
                        
                        snapshot.forEach(userSnapshot => {
                            const user = userSnapshot.val();
                            user.id = userSnapshot.key;
                            
                            const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString('pt-BR') : 'Nunca';
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user.name}</td>
                                <td>${user.email}</td>
                                <td>${user.userType === 'admin' || user.isAdmin ? 'Administrador' : 'Usu√°rio Normal'}</td>
                                <td>${lastLogin}</td>
                                <td class="text-end">
                                    ${user.id !== currentUser.uid ? `
                                    <button class="btn btn-sm btn-danger delete-user-btn" data-id="${user.id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    ` : ''}
                                </td>
                            `;
                            usersTableBody.appendChild(row);
                        });
                        
                        // Adicionar eventos aos bot√µes de exclus√£o
                        document.querySelectorAll('.delete-user-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const userId = this.getAttribute('data-id');
                                
                                if (confirm('Tem certeza que deseja excluir este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) {
                                    database.ref(`users/${userId}`).remove()
                                        .then(() => {
                                            // Registrar log
                                            return database.ref('system_logs').push().set({
                                                type: 'user_deleted',
                                                userId: currentUser.uid,
                                                userEmail: currentUser.email,
                                                userName: userData.name,
                                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                                details: `Usu√°rio ${userId} exclu√≠do`,
                                                deletedUserId: userId
                                            });
                                        })
                                        .then(() => {
                                            alert('Usu√°rio exclu√≠do com sucesso!');
                                            loadUsersTable();
                                        })
                                        .catch(error => {
                                            alert('Erro ao excluir usu√°rio: ' + error.message);
                                        });
                                }
                            });
                        });
                    });
            }
            
            // Carregar logs do sistema
            function loadSystemLogs() {
                if (!currentUser || !(userData.userType === 'admin' || userData.isAdmin)) return;
                
                logsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Carregando...</td></tr>';
                
                database.ref('system_logs').orderByChild('timestamp').limitToLast(50).once('value')
                    .then((snapshot) => {
                        logsTableBody.innerHTML = '';
                        
                        if (!snapshot.exists()) {
                            logsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum log encontrado</td></tr>';
                            return;
                        }
                        
                        const logs = [];
                        snapshot.forEach(logSnapshot => {
                            const log = logSnapshot.val();
                            log.id = logSnapshot.key;
                            logs.push(log);
                        });
                        
                        // Ordenar logs por timestamp (do mais recente para o mais antigo)
                        logs.sort((a, b) => b.timestamp - a.timestamp);
                        
                        logs.forEach(log => {
                            const date = new Date(log.timestamp);
                            const dateStr = date.toLocaleString('pt-BR');
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${dateStr}</td>
                                <td>${log.userName || log.userEmail}</td>
                                <td>${getLogActionDescription(log.type)}</td>
                                <td>${log.details || ''}</td>
                            `;
                            logsTableBody.appendChild(row);
                        });
                    });
            }
            
            // Obter descri√ß√£o da a√ß√£o do log
            function getLogActionDescription(type) {
                const descriptions = {
                    'login': 'Login',
                    'logout': 'Logout',
                    'plan_created': 'Plano criado',
                    'plan_completed': 'Plano conclu√≠do',
                    'plan_canceled': 'Plano cancelado',
                    'action_completed': 'A√ß√£o conclu√≠da',
                    'action_canceled': 'A√ß√£o cancelada',
                    'action_date_changed': 'Data da a√ß√£o alterada',
                    'admin_request_created': 'Solicita√ß√£o de admin criada',
                    'admin_request_processed': 'Solicita√ß√£o de admin processada',
                    'user_deleted': 'Usu√°rio exclu√≠do',
                    'notification_sent': 'Notifica√ß√£o enviada'
                };
                
                return descriptions[type] || type;
            }

            // Carregar configura√ß√µes de notifica√ß√£o
            function loadNotificationSettings() {
                if (!currentUser) return;

                notificationEmailsTable.innerHTML = '<tr><td colspan="3" class="text-center">Carregando...</td></tr>';

                // Carregar emails cadastrados
                database.ref(`notification_emails/${currentUser.uid}`).once('value')
                    .then((snapshot) => {
                        notificationEmailsTable.innerHTML = '';

                        if (!snapshot.exists()) {
                            notificationEmailsTable.innerHTML = '<tr><td colspan="3" class="text-center">Nenhum email cadastrado</td></tr>';
                        } else {
                            snapshot.forEach(emailSnapshot => {
                                const emailData = emailSnapshot.val();
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${typeof emailData === 'string' ? emailData : emailData.email}</td>
                                    <td>${formatDate(emailData.createdAt || emailSnapshot.key)}</td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-danger delete-email-btn" data-id="${emailSnapshot.key}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                `;
                                notificationEmailsTable.appendChild(row);
                            });

                            // Adicionar eventos aos bot√µes de exclus√£o
                            document.querySelectorAll('.delete-email-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const emailId = this.getAttribute('data-id');
                                    database.ref(`notification_emails/${currentUser.uid}/${emailId}`).remove()
                                        .then(() => {
                                            loadNotificationSettings();
                                        })
                                        .catch(error => {
                                            alert('Erro ao remover email: ' + error.message);
                                        });
                                });
                            });
                        }
                    });

                // Carregar configura√ß√µes de notifica√ß√£o
                database.ref(`notification_settings/${currentUser.uid}`).once('value')
                    .then((snapshot) => {
                        const settings = snapshot.val() || {};
                        enableNotifications.checked = settings.enabled !== false; // Padr√£o: true
                        notificationTime.value = settings.time || '09:00';
                    });
            }

            // Adicionar email para notifica√ß√£o
            notificationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!currentUser) return;

                const email = notificationEmailInput.value.trim();
                if (!email) {
                    alert('Por favor, insira um email v√°lido');
                    return;
                }

                const emailRef = database.ref(`notification_emails/${currentUser.uid}`).push();
                emailRef.set({
                    email: email,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    notificationEmailInput.value = '';
                    loadNotificationSettings();
                }).catch(error => {
                    alert('Erro ao adicionar email: ' + error.message);
                });
            });

            // Salvar configura√ß√µes de notifica√ß√£o
            saveNotificationSettings.addEventListener('click', function() {
                if (!currentUser) return;

                const settings = {
                    enabled: enableNotifications.checked,
                    time: notificationTime.value
                };

                database.ref(`notification_settings/${currentUser.uid}`).set(settings)
                    .then(() => {
                        alert('Configura√ß√µes salvas com sucesso!');
                    })
                    .catch(error => {
                        alert('Erro ao salvar configura√ß√µes: ' + error.message);
                    });
            });

            // Enviar email de teste
            testNotificationBtn.addEventListener('click', function() {
                if (!currentUser || !userData) {
                    alert('Voc√™ precisa estar logado');
                    return;
                }

                // Verificar se h√° emails cadastrados
                database.ref(`notification_emails/${currentUser.uid}`).once('value')
                    .then((snapshot) => {
                        if (!snapshot.exists() || snapshot.numChildren() === 0) {
                            alert('Nenhum email cadastrado para enviar notifica√ß√£o');
                            return;
                        }

                        // Obter a√ß√µes atrasadas
                        database.ref('plans').once('value')
                            .then((plansSnapshot) => {
                                const lateActions = [];
                                const today = new Date();

                                plansSnapshot.forEach(planSnapshot => {
                                    const plan = planSnapshot.val();
                                    if (!plan.actions) return;

                                    plan.actions.forEach(action => {
                                        if (action.status !== 'Conclu√≠do' && action.endDate) {
                                            const endDate = new Date(action.endDate);
                                            if (endDate < today) {
                                                lateActions.push({
                                                    planTitle: plan.title,
                                                    activity: action.activity,
                                                    responsible: action.responsible,
                                                    endDate: formatDate(action.endDate),
                                                    daysLate: Math.floor((today - endDate) / (1000 * 60 * 60 * 24))
                                                });
                                            }
                                        }
                                    });
                                });

                                if (lateActions.length === 0) {
                                    alert('Nenhuma a√ß√£o atrasada encontrada para notificar');
                                    return;
                                }

                                // Construir mensagem
                                let message = `<h2>Notifica√ß√£o de A√ß√µes Atrasadas</h2>`;
                                message += `<p>Ol√°, ${userData.name}!</p>`;
                                message += `<p>Voc√™ tem <strong>${lateActions.length} a√ß√µes atrasadas</strong> no sistema:</p>`;
                                message += `<ul>`;
                                lateActions.forEach(action => {
                                    message += `<li><strong>${action.planTitle}</strong>: ${action.activity} (Respons√°vel: ${action.responsible}, Atraso: ${action.daysLate} dias)</li>`;
                                });
                                message += `</ul>`;
                                message += `<p>Acesse o sistema para atualizar o status dessas a√ß√µes.</p>`;

                                // Enviar para cada email cadastrado
                                snapshot.forEach(emailSnap => {
                                    const data = emailSnap.val();
                                    const toEmail = typeof data === 'string' ? data : data.email;

                                    // Par√¢metros para o e-mail
                                    const params = {
                                        to_email: toEmail,
                                        name: userData.name,
                                        message: message
                                    };

                                    console.log("Enviando e-mail para:", toEmail);

                                    emailjs.send("service_98e468r", "template_mvgbfgp", params)
                                        .then((response) => {
                                            console.log("‚úÖ Email enviado com sucesso para", toEmail, response.status);
                                            // Registrar log
                                            return database.ref('system_logs').push().set({
                                                type: 'notification_sent',
                                                userId: currentUser.uid,
                                                userEmail: currentUser.email,
                                                userName: userData.name,
                                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                                details: `Email de teste enviado para ${toEmail}`,
                                                recipient: toEmail
                                            });
                                        })
                                        .then(() => {
                                            alert('Email de teste enviado com sucesso para todos os destinat√°rios cadastrados!');
                                        })
                                        .catch((error) => {
                                            console.error("‚ùå Erro ao enviar para", toEmail, error);
                                        });
                                });
                            });
                    });
            });

            // Verificar notifica√ß√µes pendentes
            function checkForNotifications() {
                if (!currentUser) return;

                database.ref(`notification_settings/${currentUser.uid}`).once('value')
                    .then((settingsSnapshot) => {
                        const settings = settingsSnapshot.val() || {};
                        
                        // Verificar se notifica√ß√µes est√£o habilitadas
                        if (settings.enabled === false) return;
                        
                        // Obter hora atual
                        const now = new Date();
                        const currentHour = now.getHours().toString().padStart(2, '0');
                        const currentMinute = now.getMinutes().toString().padStart(2, '0');
                        const currentTime = `${currentHour}:${currentMinute}`;
                        
                        // Verificar se √© hora de enviar notifica√ß√µes
                        if (settings.time && settings.time === currentTime) {
                            // Verificar se j√° foi enviado hoje
                            const today = now.toISOString().split('T')[0];
                            database.ref(`last_notification_sent/${currentUser.uid}`).once('value')
                                .then((lastSentSnapshot) => {
                                    const lastSentDate = lastSentSnapshot.val();
                                    
                                    if (lastSentDate !== today) {
                                        // Obter a√ß√µes atrasadas
                                        database.ref('plans').orderByChild('createdBy').equalTo(currentUser.uid).once('value')
                                            .then((plansSnapshot) => {
                                                const lateActions = [];
                                                const todayDate = new Date();
                                                
                                                plansSnapshot.forEach(planSnapshot => {
                                                    const plan = planSnapshot.val();
                                                    if (!plan.actions) return;
                                                    
                                                    plan.actions.forEach(action => {
                                                        if (action.status !== 'Conclu√≠do' && action.endDate) {
                                                            const endDate = new Date(action.endDate);
                                                            if (endDate < todayDate) {
                                                                lateActions.push({
                                                                    planTitle: plan.title,
                                                                    activity: action.activity,
                                                                    responsible: action.responsible,
                                                                    endDate: formatDate(action.endDate),
                                                                    daysLate: Math.floor((todayDate - endDate) / (1000 * 60 * 60 * 24))
                                                                });
                                                            }
                                                        }
                                                    });
                                                });

                                                if (lateActions.length > 0) {
                                                    // Atualizar badge de notifica√ß√£o
                                                    updateNotificationBadge(lateActions.length);
                                                    
                                                    // Marcar como enviado hoje
                                                    database.ref(`last_notification_sent/${currentUser.uid}`).set(today);
                                                    
                                                    // Enviar notifica√ß√µes por email
                                                    database.ref(`notification_emails/${currentUser.uid}`).once('value')
                                                        .then((emailsSnapshot) => {
                                                            if (!emailsSnapshot.exists()) return;
                                                            
                                                            // Construir mensagem
                                                            let message = `<h2>Notifica√ß√£o de A√ß√µes Atrasadas</h2>`;
                                                            message += `<p>Ol√°, ${userData.name}!</p>`;
                                                            message += `<p>Voc√™ tem <strong>${lateActions.length} a√ß√µes atrasadas</strong> no sistema:</p>`;
                                                            message += `<ul>`;
                                                            lateActions.forEach(action => {
                                                                message += `<li><strong>${action.planTitle}</strong>: ${action.activity} (Respons√°vel: ${action.responsible}, Atraso: ${action.daysLate} dias)</li>`;
                                                            });
                                                            message += `</ul>`;
                                                            message += `<p>Acesse o sistema para atualizar o status dessas a√ß√µes.</p>`;
                                                            
                                                            // Enviar para cada email cadastrado
                                                            emailsSnapshot.forEach(emailSnap => {
                                                                const data = emailSnap.val();
                                                                const toEmail = typeof data === 'string' ? data : data.email;

                                                                // Par√¢metros para o e-mail
                                                                const params = {
                                                                    to_email: toEmail,
                                                                    name: userData.name,
                                                                    message: message
                                                                };

                                                                emailjs.send("service_98e468r", "template_mvgbfgp", params)
                                                                    .then(() => {
                                                                        // Registrar log
                                                                        return database.ref('system_logs').push().set({
                                                                            type: 'notification_sent',
                                                                            userId: currentUser.uid,
                                                                            userEmail: currentUser.email,
                                                                            userName: userData.name,
                                                                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                                                                            details: `Notifica√ß√£o autom√°tica enviada para ${toEmail} com ${lateActions.length} a√ß√µes atrasadas`,
                                                                            recipient: toEmail
                                                                        });
                                                                    })
                                                                    .catch(error => {
                                                                        console.error("Erro ao enviar notifica√ß√£o para", toEmail, error);
                                                                    });
                                                            });
                                                        });
                                                }
                                            });
                                    }
                                });
                        }
                    });
            }

            // Verificar solicita√ß√µes pendentes de administra√ß√£o
            function checkForAdminRequests() {
                if (!currentUser || !(userData.userType === 'admin' || userData.isAdmin)) return;
                
                database.ref('admin_requests').orderByChild('status').equalTo('pending').once('value')
                    .then((snapshot) => {
                        let pendingCount = 0;
                        
                        if (snapshot.exists()) {
                            snapshot.forEach(() => {
                                pendingCount++;
                            });
                        }
                        
                        updateAdminBadge(pendingCount);
                    });
            }

            // Iniciar verifica√ß√£o peri√≥dica de notifica√ß√µes
            function startNotificationCheck() {
                // Verificar a cada minuto
                notificationCheckInterval = setInterval(checkForNotifications, 60000);
                // Verificar imediatamente ao carregar
                checkForNotifications();
            }

            // Iniciar verifica√ß√£o peri√≥dica de solicita√ß√µes de administra√ß√£o
            function startAdminCheck() {
                // Verificar a cada 5 minutos
                adminCheckInterval = setInterval(checkForAdminRequests, 300000);
                // Verificar imediatamente ao carregar
                checkForAdminRequests();
            }

            // Parar verifica√ß√£o de notifica√ß√µes
            function stopNotificationCheck() {
                if (notificationCheckInterval) {
                    clearInterval(notificationCheckInterval);
                }
            }

            // Parar verifica√ß√£o de solicita√ß√µes de administra√ß√£o
            function stopAdminCheck() {
                if (adminCheckInterval) {
                    clearInterval(adminCheckInterval);
                }
            }

            // Atualizar badge de notifica√ß√£o
            function updateNotificationBadge(count) {
                if (count > 0) {
                    notificationBadge.textContent = count;
                    notificationBadge.classList.remove('d-none');
                } else {
                    notificationBadge.classList.add('d-none');
                }
            }
            
            // Atualizar badge de administra√ß√£o
            function updateAdminBadge(count) {
                if (count > 0) {
                    pendingRequestsBadge.textContent = count;
                    document.getElementById('admin-badge').textContent = count;
                    document.getElementById('admin-badge').classList.remove('d-none');
                } else {
                    document.getElementById('admin-badge').classList.add('d-none');
                    pendingRequestsBadge.textContent = '0';
                }
            }

            // Fun√ß√µes auxiliares
            function formatDate(dateString) {
                if (!dateString) return 'N√£o definido';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('pt-BR');
                } catch (e) {
                    return dateString; // Retorna o valor original se n√£o puder ser convertido
                }
            }

            function getPriorityBadgeClass(priority) {
                switch (priority) {
                    case 'Baixa': return 'bg-secondary';
                    case 'M√©dia': return 'bg-primary';
                    case 'Alta': return 'bg-warning text-dark';
                    case 'Cr√≠tica': return 'bg-danger';
                    default: return 'bg-secondary';
                }
            }

            function getStatusBadgeClass(status) {
                switch (status) {
                    case 'N√£o Iniciado': return 'bg-secondary';
                    case 'Em Andamento': return 'bg-primary';
                    case 'Conclu√≠do': return 'bg-success';
                    case 'Cancelado': return 'bg-danger';
                    default: return 'bg-secondary';
                }
            }

            // Eventos de filtro e busca
            planFilter.addEventListener('change', loadActionsTable);
            actionStatusFilter.addEventListener('change', loadActionsTable);
            actionAreaFilter.addEventListener('change', loadActionsTable);
            actionUnitFilter.addEventListener('change', loadActionsTable);
            searchActionsInput.addEventListener('input', loadActionsTable);
            
            managePlanFilter.addEventListener('change', loadManageActions);
            statusFilter.addEventListener('change', loadManageActions);
            manageAreaFilter.addEventListener('change', loadManageActions);
            manageUnitFilter.addEventListener('change', loadManageActions);
            searchManageActionsInput.addEventListener('input', loadManageActions);
            
            dashboardPlanFilter.addEventListener('change', loadDashboardData);
            dashboardAreaFilter.addEventListener('change', loadDashboardData);
            dashboardUnitFilter.addEventListener('change', loadDashboardData);
            
            plansAreaFilter.addEventListener('change', loadPlansTable);
            plansUnitFilter.addEventListener('change', loadPlansTable);
            searchPlansInput.addEventListener('input', loadPlansTable);

            // Verificar estado de autentica√ß√£o ao carregar a p√°gina
            // Substitua o c√≥digo atual por algo como:
auth.onAuthStateChanged((user) => {
    if (user) {
        // Apenas armazene o usu√°rio, mas n√£o redirecione
        currentUser = user;
        console.log('Usu√°rio detectado, mas n√£o redirecionando automaticamente');
        
        // Opcional: mostrar um bot√£o "Continuar como [email]"
        showLoginOption(user.email);
    } else {
        currentUser = null;
        userData = null;
    }
});

function showLoginOption(email) {
    // Implemente uma UI para permitir que o usu√°rio escolha continuar ou n√£o
}
            });
// Menu hamburguer para mobile
document.addEventListener('DOMContentLoaded', function() {
  // Criar bot√£o de toggle para o menu
  const navbarToggler = document.createElement('button');
  navbarToggler.className = 'navbar-toggler d-lg-none';
  navbarToggler.innerHTML = '<i class="bi bi-list"></i>';
  navbarToggler.style.position = 'fixed';
  navbarToggler.style.top = '10px';
  navbarToggler.style.left = '10px';
  navbarToggler.style.zIndex = '1051';
  navbarToggler.style.fontSize = '1.5rem';
  navbarToggler.style.backgroundColor = 'rgba(255,255,255,0.8)';
  navbarToggler.style.border = 'none';
  navbarToggler.style.borderRadius = '50%';
  navbarToggler.style.width = '40px';
  navbarToggler.style.height = '40px';
  navbarToggler.style.display = 'none'; // Escondido por padr√£o
  
  document.body.appendChild(navbarToggler);
  
  // Criar overlay para o menu
  const menuOverlay = document.createElement('div');
  menuOverlay.className = 'menu-overlay';
  menuOverlay.style.position = 'fixed';
  menuOverlay.style.top = '0';
  menuOverlay.style.left = '0';
  menuOverlay.style.width = '100%';
  menuOverlay.style.height = '100%';
  menuOverlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
  menuOverlay.style.zIndex = '1049';
  menuOverlay.style.opacity = '0';
  menuOverlay.style.visibility = 'hidden';
  menuOverlay.style.transition = 'opacity 0.3s, visibility 0.3s';
  document.body.appendChild(menuOverlay);
  
  // Mostrar/ocultar menu no mobile
  navbarToggler.addEventListener('click', function() {
    document.querySelector('.sidebar').classList.toggle('active');
    menuOverlay.style.opacity = '1';
    menuOverlay.style.visibility = 'visible';
  });
  
  menuOverlay.addEventListener('click', function() {
    document.querySelector('.sidebar').classList.remove('active');
    menuOverlay.style.opacity = '0';
    menuOverlay.style.visibility = 'hidden';
  });
  
  // Ajustar visibilidade do bot√£o de toggle
  function handleResponsive() {
    if (window.innerWidth <= 768) {
      navbarToggler.style.display = 'flex';
      navbarToggler.style.alignItems = 'center';
      navbarToggler.style.justifyContent = 'center';
      document.querySelector('.sidebar').classList.remove('active');
      menuOverlay.style.opacity = '0';
      menuOverlay.style.visibility = 'hidden';
    } else {
      navbarToggler.style.display = 'none';
      document.querySelector('.sidebar').classList.add('active');
    }
  }
  
  // Verificar no carregamento e no redimensionamento
  window.addEventListener('load', handleResponsive);
  window.addEventListener('resize', handleResponsive);
  
  // Ajustar modais para mobile
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    modal.addEventListener('shown.bs.modal', function() {
      if (window.innerWidth <= 576) {
        modal.querySelector('.modal-dialog').classList.add('modal-fullscreen');
      }
    });
  });
  
  // Ajustar inputs para mobile
  const inputs = document.querySelectorAll('input, select, textarea');
  inputs.forEach(input => {
    input.addEventListener('focus', function() {
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          this.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }
    });
  });
});
    </script>
</body>
</html>